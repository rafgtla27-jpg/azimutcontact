<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Contact Map | AzimutTrans</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.sheetjs.com/xlsx-0.20.3/package/dist/xlsx.full.min.js"></script>
    <style>
        :root {
            --primary: #6366f1;
            --primary-hover: #4f46e5;
            --bg: #0f172a;
            --sidebar-bg: #1e293b;
            --card-bg: #263548;
            --card-hover: #2e4060;
            --text: #f1f5f9;
            --text-muted: #94a3b8;
            --border: #334155;
            --success: #22c55e;
            --danger: #ef4444;
            --warning: #f59e0b;
        }

        *, *::before, *::after { box-sizing: border-box; }

        body {
            margin: 0;
            font-family: 'Inter', sans-serif;
            background: var(--bg);
            color: var(--text);
            overflow: hidden;
            height: 100vh;
        }

        /* ‚îÄ‚îÄ LOGIN ‚îÄ‚îÄ */
        #login-overlay {
            position: fixed; inset: 0;
            background: var(--bg);
            z-index: 3000;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .login-box {
            background: var(--sidebar-bg);
            padding: 48px 40px;
            border-radius: 20px;
            width: 100%;
            max-width: 400px;
            box-shadow: 0 32px 64px rgba(0,0,0,0.5);
            border: 1px solid var(--border);
        }
        .login-logo {
            text-align: center;
            margin-bottom: 32px;
        }
        .login-logo span {
            font-size: 2rem;
            font-weight: 700;
            background: linear-gradient(135deg, #6366f1, #8b5cf6);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .login-logo p { color: var(--text-muted); font-size: 0.875rem; margin: 4px 0 0; }

        /* ‚îÄ‚îÄ LAYOUT ‚îÄ‚îÄ */
        #main-content {
            display: none;
            width: 100%;
            height: 100vh;
            flex-direction: row;
        }
        #main-content.visible { display: flex !important; }

        /* ‚îÄ‚îÄ SIDEBAR ‚îÄ‚îÄ */
        #sidebar {
            width: 300px;
            min-width: 300px;
            height: 100vh;
            background: var(--sidebar-bg);
            border-right: 1px solid var(--border);
            overflow-y: auto;
            overflow-x: hidden;
            display: flex;
            flex-direction: column;
            gap: 0;
            z-index: 10;
        }
        #sidebar::-webkit-scrollbar { width: 4px; }
        #sidebar::-webkit-scrollbar-track { background: transparent; }
        #sidebar::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }

        .sidebar-header {
            padding: 20px;
            border-bottom: 1px solid var(--border);
            background: linear-gradient(180deg, #1e293b 0%, #162032 100%);
            position: sticky;
            top: 0;
            z-index: 5;
        }
        .sidebar-header h1 {
            font-size: 1rem;
            font-weight: 700;
            margin: 0 0 2px;
            background: linear-gradient(135deg, #818cf8, #c084fc);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .sidebar-header p { margin: 0; font-size: 0.7rem; color: var(--text-muted); }

        .sidebar-section {
            padding: 16px;
            border-bottom: 1px solid var(--border);
        }
        .sidebar-section-title {
            font-size: 0.65rem;
            font-weight: 600;
            letter-spacing: 0.1em;
            color: var(--text-muted);
            text-transform: uppercase;
            margin: 0 0 10px;
        }

        /* ‚îÄ‚îÄ MAP ‚îÄ‚îÄ */
        #map { flex: 1; height: 100vh; min-width: 0; }

        /* ‚îÄ‚îÄ BREADCRUMB ‚îÄ‚îÄ */
        #breadcrumb {
            position: absolute;
            top: 16px;
            left: 16px;
            z-index: 1000;
            background: var(--sidebar-bg);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 10px 16px;
            font-size: 0.85rem;
            font-weight: 500;
            color: var(--text);
            display: none;
            align-items: center;
            gap: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            backdrop-filter: blur(10px);
        }
        #breadcrumb.visible {
            display: flex;
        }
        .breadcrumb-item {
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .breadcrumb-separator {
            color: var(--text-muted);
            font-size: 0.7rem;
        }
        .breadcrumb-home {
            cursor: pointer;
            color: var(--primary);
            transition: all 0.2s ease;
        }
        .breadcrumb-home:hover {
            color: var(--primary-hover);
        }
        .breadcrumb-current {
            color: var(--text);
            font-weight: 600;
        }

        /* ‚îÄ‚îÄ CONTACT LIST ‚îÄ‚îÄ */
        #contact-list {
            width: 310px;
            min-width: 310px;
            height: 100vh;
            background: var(--sidebar-bg);
            border-left: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        .contact-list-header {
            padding: 16px;
            border-bottom: 1px solid var(--border);
            background: linear-gradient(180deg, #1e293b 0%, #162032 100%);
            position: sticky;
            top: 0;
            flex-shrink: 0;
        }
        #contacts-scroll {
            flex: 1;
            overflow-y: auto;
            padding: 12px;
        }
        #contacts-scroll::-webkit-scrollbar { width: 4px; }
        #contacts-scroll::-webkit-scrollbar-track { background: transparent; }
        #contacts-scroll::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }

        /* ‚îÄ‚îÄ STATS ‚îÄ‚îÄ */
        .contact-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin-bottom: 12px;
        }
        .stat-card {
            background: var(--card-bg);
            padding: 10px 12px;
            border-radius: 10px;
            text-align: center;
            border: 1px solid var(--border);
        }
        .stat-value { display: block; font-size: 1.4rem; font-weight: 700; color: var(--primary); }
        .stat-label { display: block; font-size: 0.65rem; color: var(--text-muted); margin-top: 1px; }

        /* ‚îÄ‚îÄ SEARCH ‚îÄ‚îÄ */
        .search-wrapper {
            position: relative;
            margin-bottom: 10px;
        }
        .search-wrapper svg {
            position: absolute;
            left: 10px;
            top: 50%;
            transform: translateY(-50%);
            opacity: 0.4;
        }
        .search-input {
            width: 100%;
            padding: 9px 12px 9px 36px;
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: 10px;
            color: var(--text);
            font-size: 0.8rem;
            transition: all 0.15s ease;
            font-family: 'Inter', sans-serif;
        }
        .search-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.15);
            background: var(--sidebar-bg);
        }

        /* ‚îÄ‚îÄ CITY GROUP ‚îÄ‚îÄ */
        .city-group {
            margin-bottom: 16px;
        }
        .city-group-header {
            background: var(--card-bg);
            padding: 10px 12px;
            border-radius: 10px;
            margin-bottom: 8px;
            border: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .city-group-header:hover {
            background: var(--card-hover);
            border-color: var(--primary);
        }
        .city-group-title {
            font-weight: 600;
            font-size: 0.85rem;
            color: var(--text);
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .city-group-count {
            background: var(--primary);
            color: white;
            font-size: 0.7rem;
            font-weight: 700;
            padding: 2px 8px;
            border-radius: 12px;
        }
        .city-group-contacts {
            display: flex;
            flex-direction: column;
            gap: 6px;
            padding-left: 8px;
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease, opacity 0.3s ease;
            opacity: 0;
        }
        .city-group-contacts.expanded {
            max-height: 2000px;
            opacity: 1;
        }
        .city-group-toggle {
            transition: transform 0.3s ease;
        }
        .city-group-toggle.rotated {
            transform: rotate(180deg);
        }

        /* ‚îÄ‚îÄ CONTACT CARD ‚îÄ‚îÄ */
        .contact-card {
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 11px 13px;
            cursor: pointer;
            transition: all 0.15s ease;
            position: relative;
        }
        .contact-card:hover {
            background: var(--card-hover);
            border-color: var(--primary);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.15);
        }
        .contact-card.active {
            background: var(--primary);
            border-color: var(--primary);
        }
        .contact-card.active * { color: white !important; }

        .contact-name {
            font-weight: 600;
            font-size: 0.85rem;
            margin: 0 0 3px;
            color: var(--text);
            line-height: 1.3;
        }
        .contact-meta {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }
        .contact-meta-line {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 0.7rem;
            color: var(--text-muted);
            position: relative;
        }
        .contact-meta-line svg {
            opacity: 0.5;
            flex-shrink: 0;
        }
        .copy-btn {
            display: none;
            background: var(--primary);
            border: none;
            border-radius: 4px;
            padding: 2px 6px;
            cursor: pointer;
            font-size: 0.65rem;
            color: white;
            margin-left: 6px;
            transition: all 0.2s ease;
        }
        .copy-btn:hover {
            background: var(--primary-hover);
            transform: scale(1.05);
        }
        .contact-meta-line:hover .copy-btn {
            display: inline-block;
        }

        .contact-badges {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
            margin-top: 6px;
        }
        .contact-badge {
            font-size: 0.65rem;
            padding: 2px 7px;
            border-radius: 6px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.03em;
        }
        .badge-regional { background: rgba(34, 197, 94, 0.15); color: var(--success); }
        .badge-national { background: rgba(239, 68, 68, 0.15); color: var(--danger); }

        /* ‚îÄ‚îÄ FEATURE SECTION (contacts sans localisation) ‚îÄ‚îÄ */
        .feature-section {
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.1), rgba(139, 92, 246, 0.1));
            border: 1px solid var(--primary);
            border-radius: 12px;
            padding: 14px;
            margin-bottom: 16px;
        }
        .feature-section-title {
            font-size: 0.75rem;
            font-weight: 700;
            color: var(--primary);
            margin: 0 0 10px;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .feature-contacts {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        /* ‚îÄ‚îÄ BUTTONS ‚îÄ‚îÄ */
        .btn {
            padding: 9px 14px;
            border-radius: 10px;
            border: 1px solid var(--border);
            background: var(--card-bg);
            color: var(--text);
            cursor: pointer;
            font-size: 0.8rem;
            font-weight: 500;
            transition: all 0.15s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            font-family: 'Inter', sans-serif;
            text-align: center;
        }
        .btn:hover {
            background: var(--card-hover);
            border-color: var(--primary);
        }
        .btn-primary {
            background: var(--primary);
            border-color: var(--primary);
            color: white;
        }
        .btn-primary:hover {
            background: var(--primary-hover);
        }
        .btn-success {
            background: var(--success);
            border-color: var(--success);
            color: white;
        }
        .btn-danger {
            background: var(--danger);
            border-color: var(--danger);
            color: white;
        }

        /* ‚îÄ‚îÄ FORM ‚îÄ‚îÄ */
        .form-group {
            margin-bottom: 14px;
        }
        .form-label {
            display: block;
            font-size: 0.75rem;
            font-weight: 600;
            margin-bottom: 5px;
            color: var(--text-muted);
        }
        .form-input, .form-textarea {
            width: 100%;
            padding: 9px 12px;
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: 10px;
            color: var(--text);
            font-size: 0.8rem;
            font-family: 'Inter', sans-serif;
            transition: all 0.15s ease;
        }
        .form-input:focus, .form-textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.15);
        }
        .form-textarea {
            resize: vertical;
            min-height: 70px;
        }
        .form-checkbox-wrapper {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            padding: 8px 0;
        }
        .form-checkbox {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        /* ‚îÄ‚îÄ MODAL ‚îÄ‚îÄ */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.75);
            z-index: 2000;
            display: none;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(3px);
        }
        .modal-overlay.visible { display: flex; }
        .modal-box {
            background: var(--sidebar-bg);
            border: 1px solid var(--border);
            border-radius: 18px;
            padding: 24px;
            max-width: 520px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 32px 64px rgba(0,0,0,0.6);
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 16px;
            border-bottom: 1px solid var(--border);
        }
        .modal-title {
            font-size: 1.1rem;
            font-weight: 700;
            margin: 0;
            color: var(--text);
        }
        .modal-close {
            background: transparent;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            font-size: 1.3rem;
            padding: 0;
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 6px;
            transition: all 0.15s ease;
        }
        .modal-close:hover {
            background: var(--card-bg);
            color: var(--text);
        }

        /* ‚îÄ‚îÄ TOAST ‚îÄ‚îÄ */
        #toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            display: flex;
            flex-direction: column;
            gap: 8px;
            pointer-events: none;
        }
        .toast {
            background: var(--sidebar-bg);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 12px 16px;
            font-size: 0.85rem;
            box-shadow: 0 8px 24px rgba(0,0,0,0.4);
            pointer-events: all;
            animation: toastIn 0.25s ease;
            display: flex;
            align-items: center;
            gap: 10px;
            min-width: 250px;
        }
        .toast.error { border-color: var(--danger); }
        .toast.success { border-color: var(--success); }
        .toast.warning { border-color: var(--warning); }
        @keyframes toastIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* ‚îÄ‚îÄ BACK TO TOP ‚îÄ‚îÄ */
        #back-top-btn {
            position: fixed;
            bottom: 24px;
            right: 340px;
            width: 48px;
            height: 48px;
            background: var(--primary);
            border: none;
            border-radius: 50%;
            cursor: pointer;
            display: none;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 16px rgba(99, 102, 241, 0.4);
            transition: all 0.2s ease;
            z-index: 100;
        }
        #back-top-btn.visible { display: flex; }
        #back-top-btn:hover {
            background: var(--primary-hover);
            transform: translateY(-3px);
            box-shadow: 0 8px 24px rgba(99, 102, 241, 0.5);
        }

        /* ‚îÄ‚îÄ FILTERS ‚îÄ‚îÄ */
        .filter-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
        }
        .filter-btn {
            padding: 8px 12px;
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: 10px;
            cursor: pointer;
            font-size: 0.75rem;
            font-weight: 500;
            text-align: center;
            transition: all 0.15s ease;
            color: var(--text);
            font-family: 'Inter', sans-serif;
        }
        .filter-btn:hover {
            background: var(--card-hover);
            border-color: var(--primary);
        }
        .filter-btn.active {
            background: var(--primary);
            border-color: var(--primary);
            color: white;
        }

        .region-btn, .dept-btn {
            padding: 10px 14px;
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: 10px;
            cursor: pointer;
            font-size: 0.8rem;
            font-weight: 500;
            margin-bottom: 8px;
            transition: all 0.15s ease;
            text-align: left;
            color: var(--text);
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-family: 'Inter', sans-serif;
        }
        .region-btn:hover, .dept-btn:hover {
            background: var(--card-hover);
            border-color: var(--primary);
        }
        .region-btn.active, .dept-btn.active {
            background: var(--primary);
            border-color: var(--primary);
            color: white;
        }
        .region-count, .dept-count {
            background: rgba(255,255,255,0.15);
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: 700;
        }
        .region-btn.active .region-count, .dept-btn.active .dept-count {
            background: rgba(255,255,255,0.25);
        }

        /* ‚îÄ‚îÄ DELIVERY ZONE DISPLAY ‚îÄ‚îÄ */
        .delivery-zone-info {
            background: linear-gradient(135deg, rgba(245, 158, 11, 0.1), rgba(251, 191, 36, 0.1));
            border: 1px solid var(--warning);
            border-radius: 10px;
            padding: 12px;
            margin-top: 12px;
            font-size: 0.8rem;
        }
        .delivery-zone-title {
            font-weight: 700;
            color: var(--warning);
            margin: 0 0 6px;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .delivery-zone-content {
            color: var(--text);
            line-height: 1.5;
        }

        /* ‚îÄ‚îÄ RESPONSIVE ‚îÄ‚îÄ */
        @media (max-width: 768px) {
            #sidebar { width: 100%; position: absolute; z-index: 20; }
            #contact-list { width: 100%; position: absolute; right: 0; z-index: 15; }
            #back-top-btn { right: 24px; }
        }
    </style>
</head>
<body>

<!-- LOGIN -->
<div id="login-overlay">
    <div class="login-box">
        <div class="login-logo">
            <span>AzimutTrans</span>
            <p>Contact Map</p>
        </div>
        <div style="margin-bottom: 12px;">
            <input type="text" id="username-input" placeholder="Utilisateur"
                   style="width: 100%; padding: 12px 16px; background: #263548; border: 1px solid #334155; border-radius: 10px; color: #f1f5f9; font-size: 0.9rem; font-family: 'Inter', sans-serif;">
        </div>
        <div style="margin-bottom: 16px;">
            <input type="password" id="password-input" placeholder="Mot de passe"
                   style="width: 100%; padding: 12px 16px; background: #263548; border: 1px solid #334155; border-radius: 10px; color: #f1f5f9; font-size: 0.9rem; font-family: 'Inter', sans-serif;">
        </div>
        <button onclick="checkLogin()" class="btn btn-primary" style="width: 100%; padding: 12px;">
            Se connecter
        </button>
    </div>
</div>

<!-- MAIN -->
<div id="main-content">
    <!-- SIDEBAR -->
    <div id="sidebar">
        <div class="sidebar-header">
            <h1>AzimutTrans</h1>
            <p>Gestion des contacts</p>
        </div>

        <div class="sidebar-section">
            <div class="sidebar-section-title">Statistiques</div>
            <div class="contact-stats">
                <div class="stat-card">
                    <span class="stat-value" id="total-contacts">0</span>
                    <span class="stat-label">CONTACTS</span>
                </div>
                <div class="stat-card">
                    <span class="stat-value" id="total-cities">0</span>
                    <span class="stat-label">VILLES</span>
                </div>
            </div>
        </div>

        <div class="sidebar-section">
            <div class="sidebar-section-title">Filtres</div>
            <div class="filter-grid">
                <div class="filter-btn active" onclick="setFilter('all')" data-filter="all">Tous</div>
                <div class="filter-btn" onclick="setFilter('regional')" data-filter="regional">R√©gional</div>
                <div class="filter-btn" onclick="setFilter('national')" data-filter="national">National</div>
                <div class="filter-btn" onclick="setFilter('no-scope')" data-filter="no-scope">Aucun</div>
            </div>
        </div>

        <div class="sidebar-section">
            <div class="sidebar-section-title">R√©gions</div>
            <div id="region-list"></div>
        </div>

        <div class="sidebar-section">
            <div class="sidebar-section-title">D√©partements</div>
            <div id="dept-list"></div>
        </div>

        <div class="sidebar-section">
            <div class="sidebar-section-title">Actions</div>
            <button class="btn btn-primary" onclick="openAddContactModal()" style="width: 100%; margin-bottom: 8px;">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M12 5v14M5 12h14"/>
                </svg>
                Nouveau contact
            </button>
            <label class="btn" style="width: 100%; margin-bottom: 8px;">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4M17 8l-5-5-5 5M12 3v12"/>
                </svg>
                Import Excel
                <input type="file" accept=".xlsx,.xls" onchange="importExcel(this)" style="display: none;">
            </label>
            <button class="btn btn-success" onclick="exportExcel()" style="width: 100%;">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4M7 10l5 5 5-5M12 15V3"/>
                </svg>
                Export Excel
            </button>
        </div>
    </div>

    <!-- MAP -->
    <div id="map">
        <div id="breadcrumb">
            <div class="breadcrumb-item">
                <span class="breadcrumb-home" onclick="resetMapView()">üè† France</span>
            </div>
            <span class="breadcrumb-separator">‚Ä∫</span>
            <div class="breadcrumb-item">
                <span class="breadcrumb-current" id="breadcrumb-text"></span>
            </div>
        </div>
    </div>

    <!-- CONTACT LIST -->
    <div id="contact-list">
        <div class="contact-list-header">
            <div class="search-wrapper">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="11" cy="11" r="8"/>
                    <path d="m21 21-4.35-4.35"/>
                </svg>
                <input type="text" id="contact-search" class="search-input" placeholder="Rechercher...">
            </div>
        </div>
        <div id="contacts-scroll"></div>
    </div>
</div>

<!-- MODAL ADD/EDIT -->
<div class="modal-overlay" id="contact-modal">
    <div class="modal-box">
        <div class="modal-header">
            <h2 class="modal-title" id="modal-title">Nouveau contact</h2>
            <button class="modal-close" onclick="closeContactModal()">√ó</button>
        </div>
        <form onsubmit="saveContact(event)" id="contact-form">
            <input type="hidden" id="edit-id">
            <div class="form-group">
                <label class="form-label">Pr√©nom *</label>
                <input type="text" class="form-input" id="input-firstName" required>
            </div>
            <div class="form-group">
                <label class="form-label">Nom</label>
                <input type="text" class="form-input" id="input-lastName">
            </div>
            <div class="form-group">
                <label class="form-label">Email</label>
                <input type="email" class="form-input" id="input-email">
            </div>
            <div class="form-group">
                <label class="form-label">T√©l√©phone</label>
                <input type="text" class="form-input" id="input-phone">
            </div>
            <div class="form-group">
                <label class="form-label">Entreprise</label>
                <input type="text" class="form-input" id="input-company">
            </div>
            <div class="form-group">
                <label class="form-label">Ville</label>
                <input type="text" class="form-input" id="input-city" placeholder="Ex: Paris">
            </div>
            <div class="form-group">
                <label class="form-label">Zone de d√©livrance</label>
                <textarea class="form-textarea" id="input-deliveryZone" placeholder="D√©partements ou zones couvertes..."></textarea>
            </div>
            <div class="form-group">
                <label class="form-checkbox-wrapper">
                    <input type="checkbox" class="form-checkbox" id="input-scopeRegional">
                    <span class="form-label" style="margin: 0;">Port√©e r√©gionale</span>
                </label>
            </div>
            <div class="form-group">
                <label class="form-checkbox-wrapper">
                    <input type="checkbox" class="form-checkbox" id="input-scopeNational">
                    <span class="form-label" style="margin: 0;">Port√©e nationale</span>
                </label>
            </div>
            <div style="display: flex; gap: 8px; margin-top: 20px;">
                <button type="submit" class="btn btn-primary" style="flex: 1;">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/>
                        <polyline points="17 21 17 13 7 13 7 21"/>
                        <polyline points="7 3 7 8 15 8"/>
                    </svg>
                    Enregistrer
                </button>
                <button type="button" class="btn" onclick="closeContactModal()" style="flex: 1;">Annuler</button>
            </div>
        </form>
    </div>
</div>

<!-- TOAST CONTAINER -->
<div id="toast-container"></div>

<!-- BACK TO TOP -->
<button id="back-top-btn" onclick="scrollToTop()">
    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2.5">
        <path d="M12 19V5M5 12l7-7 7 7"/>
    </svg>
</button>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// GLOBALS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let contacts = [];
let map = null;
let markers = L.markerClusterGroup();
let currentFilter = 'all';
let selectedRegion = null;
let selectedDept = null;
let selectedContact = null;
let franceGeoJSON = null;

const REGIONS = [
    "Auvergne-Rh√¥ne-Alpes", "Bourgogne-Franche-Comt√©", "Bretagne", "Centre-Val de Loire",
    "Corse", "Grand Est", "Hauts-de-France", "√éle-de-France", "Normandie",
    "Nouvelle-Aquitaine", "Occitanie", "Pays de la Loire", "Provence-Alpes-C√¥te d'Azur"
];

const DEPT_TO_REGION = {
    "01":"Auvergne-Rh√¥ne-Alpes","03":"Auvergne-Rh√¥ne-Alpes","07":"Auvergne-Rh√¥ne-Alpes","15":"Auvergne-Rh√¥ne-Alpes","26":"Auvergne-Rh√¥ne-Alpes","38":"Auvergne-Rh√¥ne-Alpes","42":"Auvergne-Rh√¥ne-Alpes","43":"Auvergne-Rh√¥ne-Alpes","63":"Auvergne-Rh√¥ne-Alpes","69":"Auvergne-Rh√¥ne-Alpes","73":"Auvergne-Rh√¥ne-Alpes","74":"Auvergne-Rh√¥ne-Alpes",
    "21":"Bourgogne-Franche-Comt√©","25":"Bourgogne-Franche-Comt√©","39":"Bourgogne-Franche-Comt√©","58":"Bourgogne-Franche-Comt√©","70":"Bourgogne-Franche-Comt√©","71":"Bourgogne-Franche-Comt√©","89":"Bourgogne-Franche-Comt√©","90":"Bourgogne-Franche-Comt√©",
    "22":"Bretagne","29":"Bretagne","35":"Bretagne","56":"Bretagne",
    "18":"Centre-Val de Loire","28":"Centre-Val de Loire","36":"Centre-Val de Loire","37":"Centre-Val de Loire","41":"Centre-Val de Loire","45":"Centre-Val de Loire",
    "2A":"Corse","2B":"Corse",
    "08":"Grand Est","10":"Grand Est","51":"Grand Est","52":"Grand Est","54":"Grand Est","55":"Grand Est","57":"Grand Est","67":"Grand Est","68":"Grand Est","88":"Grand Est",
    "02":"Hauts-de-France","59":"Hauts-de-France","60":"Hauts-de-France","62":"Hauts-de-France","80":"Hauts-de-France",
    "75":"√éle-de-France","77":"√éle-de-France","78":"√éle-de-France","91":"√éle-de-France","92":"√éle-de-France","93":"√éle-de-France","94":"√éle-de-France","95":"√éle-de-France",
    "14":"Normandie","27":"Normandie","50":"Normandie","61":"Normandie","76":"Normandie",
    "16":"Nouvelle-Aquitaine","17":"Nouvelle-Aquitaine","19":"Nouvelle-Aquitaine","23":"Nouvelle-Aquitaine","24":"Nouvelle-Aquitaine","33":"Nouvelle-Aquitaine","40":"Nouvelle-Aquitaine","47":"Nouvelle-Aquitaine","64":"Nouvelle-Aquitaine","79":"Nouvelle-Aquitaine","86":"Nouvelle-Aquitaine","87":"Nouvelle-Aquitaine",
    "09":"Occitanie","11":"Occitanie","12":"Occitanie","30":"Occitanie","31":"Occitanie","32":"Occitanie","34":"Occitanie","46":"Occitanie","48":"Occitanie","65":"Occitanie","66":"Occitanie","81":"Occitanie","82":"Occitanie",
    "44":"Pays de la Loire","49":"Pays de la Loire","53":"Pays de la Loire","72":"Pays de la Loire","85":"Pays de la Loire",
    "04":"Provence-Alpes-C√¥te d'Azur","05":"Provence-Alpes-C√¥te d'Azur","06":"Provence-Alpes-C√¥te d'Azur","13":"Provence-Alpes-C√¥te d'Azur","83":"Provence-Alpes-C√¥te d'Azur","84":"Provence-Alpes-C√¥te d'Azur"
};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// LOGIN
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function checkLogin() {
    const username = document.getElementById('username-input').value;
    const pwd = document.getElementById('password-input').value;
    if (username === 'AzimutTrans' && pwd === 'Azimut73') {
        document.getElementById('login-overlay').style.display = 'none';
        document.getElementById('main-content').classList.add('visible');
        initApp();
    } else {
        toast('Identifiants incorrects', 'error');
    }
}
document.getElementById('password-input').addEventListener('keypress', (e) => {
    if (e.key === 'Enter') checkLogin();
});
document.getElementById('username-input').addEventListener('keypress', (e) => {
    if (e.key === 'Enter') checkLogin();
});

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// INIT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function initApp() {
    await loadFromServer();
    initMap();
    refreshUI();
    initBackToTopBtn();
    document.getElementById('contact-search').addEventListener('input', filterContacts);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// MAP
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function initMap() {
    map = L.map('map').setView([46.603354, 1.888334], 6);
    L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
        attribution: '¬© OpenStreetMap contributors, ¬© CARTO',
        maxZoom: 19
    }).addTo(map);
    map.addLayer(markers);
    loadFranceGeoJSON();
}

async function loadFranceGeoJSON() {
    try {
        const resp = await fetch('https://france-geojson.gregoiredavid.fr/repo/regions.geojson');
        franceGeoJSON = await resp.json();
    } catch (err) {
        console.error('Erreur chargement GeoJSON:', err);
    }
}

function resetMapView() {
    selectedRegion = null;
    selectedDept = null;
    selectedContact = null;
    map.setView([46.603354, 1.888334], 6);
    refreshUI();
    hideBreadcrumb();
}

function showBreadcrumb(text) {
    document.getElementById('breadcrumb-text').textContent = text;
    document.getElementById('breadcrumb').classList.add('visible');
}

function hideBreadcrumb() {
    document.getElementById('breadcrumb').classList.remove('visible');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// FILTERS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function setFilter(f) {
    currentFilter = f;
    document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
    document.querySelector(`.filter-btn[data-filter="${f}"]`).classList.add('active');
    refreshUI();
}

function setRegionFilter(region) {
    if (selectedRegion === region) {
        selectedRegion = null;
        hideBreadcrumb();
    } else {
        selectedRegion = region;
        selectedDept = null;
        selectedContact = null;
        showBreadcrumb(region);
        
        // Zoomer sur la r√©gion
        if (franceGeoJSON) {
            const regionFeature = franceGeoJSON.features.find(f => f.properties.nom === region);
            if (regionFeature) {
                const bounds = L.geoJSON(regionFeature).getBounds();
                map.fitBounds(bounds, { padding: [50, 50] });
            }
        }
    }
    refreshUI();
}

function setDeptFilter(dept) {
    if (selectedDept === dept) {
        selectedDept = null;
        hideBreadcrumb();
    } else {
        selectedDept = dept;
        selectedRegion = null;
        selectedContact = null;
        const regionName = DEPT_TO_REGION[dept] || '';
        showBreadcrumb(regionName ? `${regionName} ‚Ä∫ ${dept}` : `D√©partement ${dept}`);
    }
    refreshUI();
}

function selectContact(contactId) {
    const contact = contacts.find(c => c.id === contactId);
    if (!contact) return;
    
    selectedContact = contactId;
    selectedRegion = null;
    selectedDept = null;
    
    // Construire le breadcrumb
    let breadcrumbText = '';
    if (contact.region) {
        breadcrumbText = contact.region;
        if (contact.city) {
            breadcrumbText += ` ‚Ä∫ ${contact.city}`;
        }
    } else if (contact.city) {
        breadcrumbText = contact.city;
    } else {
        breadcrumbText = `${contact.firstName} ${contact.lastName || ''}`.trim();
    }
    showBreadcrumb(breadcrumbText);
    
    // Zoomer sur le contact
    if (contact.lat && contact.lon) {
        map.setView([contact.lat, contact.lon], 12);
    }
    
    refreshUI();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// GEOCODING
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function geocode(city) {
    if (!city) return null;
    const url = `https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(city)},France&format=json&limit=1&addressdetails=1`;
    try {
        const resp = await fetch(url, { headers: { 'User-Agent': 'AzimutTransApp' } });
        const data = await resp.json();
        if (data.length > 0) {
            return {
                lat: parseFloat(data[0].lat),
                lon: parseFloat(data[0].lon),
                fullName: data[0].display_name
            };
        }
    } catch (err) {
        console.error('Erreur geocoding:', err);
    }
    return null;
}

async function findRegion(lat, lon) {
    if (!franceGeoJSON) return null;
    const point = L.latLng(lat, lon);
    for (const feature of franceGeoJSON.features) {
        const polygon = L.geoJSON(feature);
        if (polygon.getBounds().contains(point)) {
            return feature.properties.nom;
        }
    }
    return null;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// UI REFRESH
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function refreshUI() {
    refreshStats();
    refreshRegionList();
    refreshDeptList();
    refreshContactList();
    refreshMap();
}

function refreshStats() {
    const filtered = getFilteredContacts();
    const cities = [...new Set(filtered.filter(c => c.city).map(c => c.city))];
    document.getElementById('total-contacts').textContent = filtered.length;
    document.getElementById('total-cities').textContent = cities.length;
}

function refreshRegionList() {
    const filtered = getFilteredContacts();
    const regionCounts = {};
    filtered.forEach(c => {
        const r = c.region || 'Inconnu';
        regionCounts[r] = (regionCounts[r] || 0) + 1;
    });

    const html = REGIONS.map(r => {
        const count = regionCounts[r] || 0;
        if (count === 0) return '';
        const active = selectedRegion === r ? 'active' : '';
        return `
            <div class="region-btn ${active}" onclick="setRegionFilter('${r}')">
                <span>${r}</span>
                <span class="region-count">${count}</span>
            </div>
        `;
    }).join('');
    document.getElementById('region-list').innerHTML = html;
}

function refreshDeptList() {
    const filtered = getFilteredContacts();
    const deptCounts = {};
    filtered.forEach(c => {
        if (c.city) {
            const match = c.city.match(/\((\d{2}[AB]?)\)/);
            if (match) {
                const dept = match[1];
                deptCounts[dept] = (deptCounts[dept] || 0) + 1;
            }
        }
    });

    const sorted = Object.entries(deptCounts).sort((a, b) => a[0].localeCompare(b[0]));
    const html = sorted.map(([dept, count]) => {
        const active = selectedDept === dept ? 'active' : '';
        return `
            <div class="dept-btn ${active}" onclick="setDeptFilter('${dept}')">
                <span>D√©partement ${dept}</span>
                <span class="dept-count">${count}</span>
            </div>
        `;
    }).join('');
    document.getElementById('dept-list').innerHTML = html;
}

function refreshContactList() {
    const filtered = getFilteredContacts();
    
    // S√©parer les contacts avec et sans localisation
    const withLocation = filtered.filter(c => c.city);
    const withoutLocation = filtered.filter(c => !c.city);
    
    // Grouper par ville
    const cityGroups = {};
    withLocation.forEach(c => {
        const city = c.city;
        if (!cityGroups[city]) cityGroups[city] = [];
        cityGroups[city].push(c);
    });
    
    let html = '';
    
    // Afficher les contacts sans localisation comme une feature
    if (withoutLocation.length > 0) {
        html += `
            <div class="feature-section">
                <div class="feature-section-title">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M12 2L2 7l10 5 10-5-10-5z"/>
                        <path d="M2 17l10 5 10-5"/>
                        <path d="M2 12l10 5 10-5"/>
                    </svg>
                    Contacts sans localisation (${withoutLocation.length})
                </div>
                <div class="feature-contacts">
                    ${withoutLocation.map(c => renderContactCard(c)).join('')}
                </div>
            </div>
        `;
    }
    
    // Afficher les groupes de villes
    const sortedCities = Object.keys(cityGroups).sort();
    sortedCities.forEach((city, index) => {
        const cityContacts = cityGroups[city];
        const groupId = `city-group-${index}`;
        
        if (cityContacts.length === 1) {
            // Une seule personne dans cette ville : affichage direct
            html += renderContactCard(cityContacts[0]);
        } else {
            // Plusieurs personnes : regroupement avec collapse/expand
            html += `
                <div class="city-group">
                    <div class="city-group-header" onclick="toggleCityGroup('${groupId}')">
                        <div class="city-group-title">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/>
                                <circle cx="12" cy="10" r="3"/>
                            </svg>
                            ${city}
                        </div>
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <span class="city-group-count">${cityContacts.length}</span>
                            <svg class="city-group-toggle" id="toggle-${groupId}" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M6 9l6 6 6-6"/>
                            </svg>
                        </div>
                    </div>
                    <div class="city-group-contacts expanded" id="${groupId}">
                        ${cityContacts.map(c => renderContactCard(c)).join('')}
                    </div>
                </div>
            `;
        }
    });
    
    document.getElementById('contacts-scroll').innerHTML = html || '<p style="text-align:center;color:var(--text-muted);padding:20px;">Aucun contact</p>';
}

function toggleCityGroup(groupId) {
    const group = document.getElementById(groupId);
    const toggle = document.getElementById('toggle-' + groupId);
    
    if (group.classList.contains('expanded')) {
        group.classList.remove('expanded');
        toggle.classList.remove('rotated');
    } else {
        group.classList.add('expanded');
        toggle.classList.add('rotated');
    }
}

function renderContactCard(c) {
    const active = selectedContact === c.id ? 'active' : '';
    const name = `${c.firstName} ${c.lastName || ''}`.trim();
    
    let badges = '';
    if (c.scopeRegional) badges += '<span class="contact-badge badge-regional">R√©gional</span>';
    if (c.scopeNational) badges += '<span class="contact-badge badge-national">National</span>';
    
    // Afficher la zone de d√©livrance si le contact est s√©lectionn√©
    let deliveryZoneHtml = '';
    if (selectedContact === c.id && c.deliveryZone) {
        deliveryZoneHtml = `
            <div class="delivery-zone-info">
                <div class="delivery-zone-title">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="1" y="3" width="15" height="13"/>
                        <path d="M16 8h4l3 3v5h-7V8z"/>
                        <circle cx="5.5" cy="18.5" r="2.5"/>
                        <circle cx="18.5" cy="18.5" r="2.5"/>
                    </svg>
                    Zone de d√©livrance
                </div>
                <div class="delivery-zone-content">${c.deliveryZone}</div>
            </div>
        `;
    }
    
    return `
        <div class="contact-card ${active}" onclick="selectContact('${c.id}')">
            <div class="contact-name">${name}</div>
            <div class="contact-meta">
                ${c.company ? `
                    <div class="contact-meta-line">
                        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/>
                        </svg>
                        <span>${c.company}</span>
                    </div>
                ` : ''}
                ${c.email ? `
                    <div class="contact-meta-line">
                        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/>
                            <polyline points="22,6 12,13 2,6"/>
                        </svg>
                        <span>${c.email}</span>
                        <button class="copy-btn" onclick="event.stopPropagation();copyToClipboard('${c.email}', 'Email copi√©')">üìã</button>
                    </div>
                ` : ''}
                ${c.phone ? `
                    <div class="contact-meta-line">
                        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"/>
                        </svg>
                        <span>${c.phone}</span>
                        <button class="copy-btn" onclick="event.stopPropagation();copyToClipboard('${c.phone}', 'T√©l√©phone copi√©')">üìã</button>
                    </div>
                ` : ''}
                ${c.region ? `
                    <div class="contact-meta-line">
                        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/>
                            <circle cx="12" cy="10" r="3"/>
                        </svg>
                        <span>${c.region}</span>
                    </div>
                ` : ''}
            </div>
            ${badges ? `<div class="contact-badges">${badges}</div>` : ''}
            ${deliveryZoneHtml}
            <div style="display:flex;gap:6px;margin-top:8px;">
                <button onclick="event.stopPropagation();editContact('${c.id}')" class="btn" style="flex:1;padding:6px;font-size:0.7rem;">
                    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
                        <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
                    </svg>
                </button>
                <button onclick="event.stopPropagation();deleteContact('${c.id}')" class="btn btn-danger" style="flex:1;padding:6px;font-size:0.7rem;">
                    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="3 6 5 6 21 6"/>
                        <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                    </svg>
                </button>
            </div>
        </div>
    `;
}

function refreshMap() {
    markers.clearLayers();
    const filtered = getFilteredContacts();
    filtered.forEach(c => {
        if (c.lat && c.lon) {
            const marker = L.marker([c.lat, c.lon]);
            const name = `${c.firstName} ${c.lastName || ''}`.trim();
            marker.bindPopup(`<strong>${name}</strong><br>${c.city || ''}`);
            markers.addLayer(marker);
        }
    });
}

function getFilteredContacts() {
    let filtered = contacts;

    if (currentFilter === 'regional') filtered = filtered.filter(c => c.scopeRegional);
    else if (currentFilter === 'national') filtered = filtered.filter(c => c.scopeNational);
    else if (currentFilter === 'no-scope') filtered = filtered.filter(c => !c.scopeRegional && !c.scopeNational);

    if (selectedRegion) filtered = filtered.filter(c => c.region === selectedRegion);
    if (selectedDept) filtered = filtered.filter(c => c.city && c.city.includes(`(${selectedDept})`));

    const search = document.getElementById('contact-search').value.toLowerCase();
    if (search) {
        filtered = filtered.filter(c => {
            const name = `${c.firstName} ${c.lastName}`.toLowerCase();
            const city = (c.city || '').toLowerCase();
            const company = (c.company || '').toLowerCase();
            return name.includes(search) || city.includes(search) || company.includes(search);
        });
    }

    return filtered;
}

function filterContacts() {
    refreshUI();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CONTACT CRUD
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function openAddContactModal() {
    document.getElementById('modal-title').textContent = 'Nouveau contact';
    document.getElementById('contact-form').reset();
    document.getElementById('edit-id').value = '';
    document.getElementById('contact-modal').classList.add('visible');
}

function closeContactModal() {
    document.getElementById('contact-modal').classList.remove('visible');
}

async function saveContact(e) {
    e.preventDefault();
    const id = document.getElementById('edit-id').value;
    const firstName = document.getElementById('input-firstName').value.trim();
    const lastName = document.getElementById('input-lastName').value.trim();
    const email = document.getElementById('input-email').value.trim();
    const phone = document.getElementById('input-phone').value.trim();
    const company = document.getElementById('input-company').value.trim();
    const city = document.getElementById('input-city').value.trim();
    const deliveryZone = document.getElementById('input-deliveryZone').value.trim();
    const scopeRegional = document.getElementById('input-scopeRegional').checked;
    const scopeNational = document.getElementById('input-scopeNational').checked;

    let lat = null, lon = null, fullName = '', region = '';
    if (city) {
        toast('G√©ocodage en cours...', 'warning');
        const coords = await geocode(city);
        if (coords) {
            lat = coords.lat;
            lon = coords.lon;
            fullName = coords.fullName;
            region = await findRegion(lat, lon);
        }
    }

    const nc = { firstName, lastName, email, phone, company, city, region, deliveryZone, scopeRegional, scopeNational, lat, lon, fullName };

    if (id) {
        const idx = contacts.findIndex(c => c.id === id);
        if (idx >= 0) contacts[idx] = { ...contacts[idx], ...nc };
        toast('Contact modifi√©');
    } else {
        contacts.push({ id: Date.now().toString() + Math.random(), ...nc });
        toast('Contact ajout√©');
    }

    await saveToServer();
    closeContactModal();
    refreshUI();
}

function editContact(id) {
    const c = contacts.find(x => x.id === id);
    if (!c) return;

    document.getElementById('modal-title').textContent = 'Modifier le contact';
    document.getElementById('edit-id').value = c.id;
    document.getElementById('input-firstName').value = c.firstName || '';
    document.getElementById('input-lastName').value = c.lastName || '';
    document.getElementById('input-email').value = c.email || '';
    document.getElementById('input-phone').value = c.phone || '';
    document.getElementById('input-company').value = c.company || '';
    document.getElementById('input-city').value = c.city || '';
    document.getElementById('input-deliveryZone').value = c.deliveryZone || '';
    document.getElementById('input-scopeRegional').checked = c.scopeRegional || false;
    document.getElementById('input-scopeNational').checked = c.scopeNational || false;

    document.getElementById('contact-modal').classList.add('visible');
}

async function deleteContact(id) {
    if (!confirm('Supprimer ce contact ?')) return;
    contacts = contacts.filter(c => c.id !== id);
    await saveToServer();
    refreshUI();
    toast('Contact supprim√©');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SERVER STORAGE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function saveToServer() {
    try {
        const resp = await fetch('https://azimuttrans-api.replit.app/save', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ contacts })
        });
        if (!resp.ok) throw new Error('Erreur serveur');
    } catch (err) {
        console.error('Erreur sauvegarde:', err);
        toast('Erreur de sauvegarde', 'error');
    }
}

async function loadFromServer() {
    try {
        const resp = await fetch('https://azimuttrans-api.replit.app/load');
        if (resp.ok) {
            const data = await resp.json();
            contacts = data.contacts || [];
        }
    } catch (err) {
        console.error('Erreur chargement:', err);
    }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// EXPORT EXCEL
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function exportExcel() {
    if (contacts.length === 0) {
        toast('Aucun contact √† exporter', 'warning');
        return;
    }
    const data = contacts.map(c => ({
        Prenom: c.firstName,
        Nom: c.lastName,
        Email: c.email,
        Phone: c.phone,
        Company: c.company,
        Ville: c.city,
        Region: c.region,
        'Zone de d√©livrance': c.deliveryZone,
        Scope: (c.scopeRegional ? 'R√©gional ' : '') + (c.scopeNational ? 'National' : '')
    }));
    const ws = XLSX.utils.json_to_sheet(data);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, 'Contacts');
    XLSX.writeFile(wb, 'contacts_azimuttrans.xlsx');
    toast('Export r√©ussi');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// IMPORT EXCEL
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function parseScope(s) {
    if (!s) return { scopeRegional: false, scopeNational: false };
    const l = s.toString().toLowerCase();
    return {
        scopeRegional: l.includes('r√©gional') || l.includes('regional'),
        scopeNational: l.includes('national')
    };
}

function showImportProgress(msg, current, total) {
    let el = document.getElementById('import-progress-container');
    if (!el) {
        el = document.createElement('div');
        el.id = 'import-progress-container';
        el.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.75);z-index:9999;display:flex;align-items:center;justify-content:center;';
        el.innerHTML = `
            <div style="background:#1e293b;border:1px solid #334155;border-radius:16px;padding:32px;min-width:380px;text-align:center;">
                <div style="font-size:1rem;font-weight:600;color:#f1f5f9;margin-bottom:6px;" id="imp-msg"></div>
                <div style="font-size:0.75rem;color:#94a3b8;margin-bottom:16px;" id="imp-count"></div>
                <div style="background:#334155;border-radius:999px;height:8px;overflow:hidden;">
                    <div id="imp-bar" style="background:linear-gradient(90deg,#6366f1,#8b5cf6);height:100%;width:0%;transition:width 0.3s ease;border-radius:999px;"></div>
                </div>
            </div>`;
        document.body.appendChild(el);
    }
    const pct = total > 0 ? Math.round((current / total) * 100) : 0;
    document.getElementById('imp-bar').style.width = pct + '%';
    document.getElementById('imp-msg').textContent   = msg;
    document.getElementById('imp-count').textContent = `${current} / ${total}`;
}

function hideImportProgress() {
    const el = document.getElementById('import-progress-container');
    if (el) el.remove();
}

function showImportChoiceDialog(existingCount, newCount) {
    return new Promise(resolve => {
        const ov = document.createElement('div');
        ov.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.8);z-index:10000;display:flex;align-items:center;justify-content:center;backdrop-filter:blur(4px);';
        ov.innerHTML = `
            <div style="background:#1e293b;border:1px solid #334155;border-radius:18px;padding:32px;max-width:420px;width:90%;font-family:'Inter',sans-serif;animation:modalIn 0.2s ease;">
                <div style="font-size:1.5rem;margin-bottom:8px;">üìÇ</div>
                <div style="font-size:1rem;font-weight:700;color:#f1f5f9;margin-bottom:8px;">Import Excel</div>
                <p style="color:#94a3b8;font-size:0.85rem;margin:0 0 20px;line-height:1.5;">
                    Base actuelle : <strong style="color:#f1f5f9">${existingCount} contact(s)</strong><br>
                    Fichier : <strong style="color:#f1f5f9">${newCount} ligne(s)</strong><br>
                    Que souhaitez-vous faire ?
                </p>
                <div style="display:flex;flex-direction:column;gap:8px;">
                    <button id="bi-replace" style="background:#7f1d1d;color:#f87171;border:1px solid #991b1b;border-radius:10px;padding:12px 16px;cursor:pointer;font-size:0.85rem;font-weight:600;text-align:left;font-family:'Inter',sans-serif;">
                        üóëÔ∏è Remplacer ‚Äî Supprimer les anciens et importer
                    </button>
                    <button id="bi-merge" style="background:#1e3a5f;color:#60a5fa;border:1px solid #1d4ed8;border-radius:10px;padding:12px 16px;cursor:pointer;font-size:0.85rem;font-weight:600;text-align:left;font-family:'Inter',sans-serif;">
                        üîÑ Fusionner ‚Äî Mettre √† jour les existants + nouveaux
                    </button>
                    <button id="bi-cancel" style="background:transparent;color:#94a3b8;border:1px solid #475569;border-radius:10px;padding:10px 16px;cursor:pointer;font-size:0.82rem;font-family:'Inter',sans-serif;">
                        Annuler
                    </button>
                </div>
            </div>`;
        document.body.appendChild(ov);
        ov.querySelector('#bi-replace').onclick = () => { ov.remove(); resolve('replace'); };
        ov.querySelector('#bi-merge').onclick   = () => { ov.remove(); resolve('merge');   };
        ov.querySelector('#bi-cancel').onclick  = () => { ov.remove(); resolve(null);      };
    });
}

async function importExcel(input) {
    const file = input.files[0];
    if (!file) return;
    input.value = '';

    const reader = new FileReader();
    reader.onload = async (e) => {
        try {
            const wb = XLSX.read(new Uint8Array(e.target.result), { type: 'array' });
            const contactCols = ['city', 'first_name', 'ville', 'prenom'];
            let sheetName = wb.SheetNames[0];
            for (const name of wb.SheetNames) {
                const rows0 = XLSX.utils.sheet_to_json(wb.Sheets[name], { header: 1 });
                if (rows0.length > 0) {
                    const headers = (rows0[0] || []).map(h => String(h || '').toLowerCase().trim());
                    if (contactCols.some(c => headers.includes(c))) { sheetName = name; break; }
                }
            }

            const rows = XLSX.utils.sheet_to_json(wb.Sheets[sheetName]);
            if (!rows.length) { toast('Fichier vide ou format incorrect', 'error'); return; }

            let mergeMode = 'replace';
            if (contacts.length > 0) {
                const choice = await showImportChoiceDialog(contacts.length, rows.length);
                if (choice === null) return;
                mergeMode = choice;
            }

            let added = 0, updated = 0, skipped = 0;
            if (mergeMode === 'replace') contacts = [];

            showImportProgress('D√©marrage...', 0, rows.length);

            for (let i = 0; i < rows.length; i++) {
                const row = rows[i];
                const city      = (row.city      || row.City      || row.Ville    || '').toString().trim();
                const firstName = (row.first_name || row['First Name'] || row.Prenom || '').toString().trim();
                const lastName  = (row.last_name  || row['Last Name']  || row.Nom   || '').toString().trim();
                const company   = (row.Company    || row.company   || row.Entreprise || '').toString().trim();
                const email     = (row.email      || row.Email     || '').toString().trim();
                const phone     = (row.phone      || row.Phone     || row.Telephone  || '').toString().trim();
                const regionFF  = (row.Region     || row.region    || '').toString().trim();
                const deliveryZone = (row.delivery_zone || row['Zone de d√©livrance'] || '').toString().trim();
                const { scopeRegional, scopeNational } = parseScope(row.Scope || row.scope || '');

                if (!firstName && !city) { skipped++; showImportProgress('Import...', i+1, rows.length); continue; }

                showImportProgress(`üìç ${city || firstName}...`, i+1, rows.length);

                let lat = null, lon = null, fullName = '', region = regionFF;
                if (city) {
                    const coords = await geocode(city);
                    if (coords) {
                        lat = coords.lat; lon = coords.lon; fullName = coords.fullName;
                        region = await findRegion(lat, lon) || regionFF;
                        await new Promise(r => setTimeout(r, 1100));
                    }
                }

                const nc = { firstName, lastName, email, phone, city, region, company, deliveryZone, scopeRegional, scopeNational, lat, lon, fullName };

                if (mergeMode === 'merge') {
                    const idx = contacts.findIndex(c =>
                        c.firstName.toLowerCase() === firstName.toLowerCase() &&
                        (c.lastName||'').toLowerCase() === lastName.toLowerCase() &&
                        (c.city||'').toLowerCase() === city.toLowerCase()
                    );
                    if (idx >= 0) { contacts[idx] = { ...contacts[idx], ...nc }; updated++; }
                    else { contacts.push({ id: Date.now().toString() + Math.random(), ...nc }); added++; }
                } else {
                    contacts.push({ id: Date.now().toString() + Math.random(), ...nc }); added++;
                }
            }

            showImportProgress('Sauvegarde...', rows.length, rows.length);
            await saveToServer();
            hideImportProgress();
            refreshUI();

            const parts = [`${added} ajout√©(s)`];
            if (updated) parts.push(`${updated} mis √† jour`);
            if (skipped) parts.push(`${skipped} ignor√©(s)`);
            toast(`‚úÖ Import : ${parts.join(' ¬∑ ')}`);

        } catch (err) {
            hideImportProgress();
            toast('Erreur import : ' + err.message, 'error');
            console.error(err);
        }
    };
    reader.readAsArrayBuffer(file);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// BACK TO TOP
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function scrollToTop() {
    document.getElementById('sidebar').scrollTo({ top: 0, behavior: 'smooth' });
    document.getElementById('contacts-scroll').scrollTo({ top: 0, behavior: 'smooth' });
}

function initBackToTopBtn() {
    const btn = document.getElementById('back-top-btn');
    const checkScroll = () => {
        const sb = document.getElementById('sidebar').scrollTop;
        const cs = document.getElementById('contacts-scroll').scrollTop;
        btn.classList.toggle('visible', sb > 150 || cs > 150);
    };
    document.getElementById('sidebar').addEventListener('scroll', checkScroll);
    document.getElementById('contacts-scroll').addEventListener('scroll', checkScroll);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// COPY TO CLIPBOARD
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function copyToClipboard(text, message) {
    navigator.clipboard.writeText(text).then(() => {
        toast(message || 'Copi√© !', 'success');
    }).catch(err => {
        console.error('Erreur copie:', err);
        toast('Erreur de copie', 'error');
    });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// TOAST
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function toast(msg, type = 'success') {
    const container = document.getElementById('toast-container');
    const toast = document.createElement('div');
    toast.className = `toast ${type}`;
    
    const icon = type === 'error' ? '‚ùå' : type === 'warning' ? '‚ö†Ô∏è' : '‚úÖ';
    toast.innerHTML = `<span style="font-size:1.2rem;">${icon}</span><span>${msg}</span>`;
    
    container.appendChild(toast);
    setTimeout(() => toast.remove(), 3000);
}
</script>
</body>
</html>
