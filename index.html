<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Contact Map | AzimutTrans</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.sheetjs.com/xlsx-0.20.3/package/dist/xlsx.full.min.js"></script>
    <style>
        :root {
            --primary: #6366f1;
            --primary-hover: #4f46e5;
            --bg: #0f172a;
            --sidebar-bg: #1e293b;
            --card-bg: #263548;
            --card-hover: #2e4060;
            --text: #f1f5f9;
            --text-muted: #94a3b8;
            --border: #334155;
            --success: #22c55e;
            --danger: #ef4444;
            --warning: #f59e0b;
        }

        *, *::before, *::after { box-sizing: border-box; }

        body {
            margin: 0;
            font-family: 'Inter', sans-serif;
            background: var(--bg);
            color: var(--text);
            overflow: hidden;
            height: 100vh;
        }

        /* ‚îÄ‚îÄ LOGIN ‚îÄ‚îÄ */
        #login-overlay {
            position: fixed; inset: 0;
            background: var(--bg);
            z-index: 3000;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .login-box {
            background: var(--sidebar-bg);
            padding: 48px 40px;
            border-radius: 20px;
            width: 100%;
            max-width: 400px;
            box-shadow: 0 32px 64px rgba(0,0,0,0.5);
            border: 1px solid var(--border);
        }
        .login-logo {
            text-align: center;
            margin-bottom: 32px;
        }
        .login-logo span {
            font-size: 2rem;
            font-weight: 700;
            background: linear-gradient(135deg, #6366f1, #8b5cf6);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .login-logo p { color: var(--text-muted); font-size: 0.875rem; margin: 4px 0 0; }

        /* ‚îÄ‚îÄ LAYOUT ‚îÄ‚îÄ */
        #main-content {
            display: none;
            width: 100%;
            height: 100vh;
            flex-direction: row;
        }
        #main-content.visible { display: flex !important; }

        /* ‚îÄ‚îÄ SIDEBAR ‚îÄ‚îÄ */
        #sidebar {
            width: 300px;
            min-width: 300px;
            height: 100vh;
            background: var(--sidebar-bg);
            border-right: 1px solid var(--border);
            overflow-y: auto;
            overflow-x: hidden;
            display: flex;
            flex-direction: column;
            gap: 0;
            z-index: 10;
        }
        #sidebar::-webkit-scrollbar { width: 4px; }
        #sidebar::-webkit-scrollbar-track { background: transparent; }
        #sidebar::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }

        .sidebar-header {
            padding: 20px;
            border-bottom: 1px solid var(--border);
            background: linear-gradient(180deg, #1e293b 0%, #162032 100%);
            position: sticky;
            top: 0;
            z-index: 5;
        }
        .sidebar-header h1 {
            font-size: 1rem;
            font-weight: 700;
            margin: 0 0 2px;
            background: linear-gradient(135deg, #818cf8, #c084fc);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .sidebar-header p { margin: 0; font-size: 0.7rem; color: var(--text-muted); }

        .sidebar-section {
            padding: 16px;
            border-bottom: 1px solid var(--border);
        }
        .sidebar-section-title {
            font-size: 0.65rem;
            font-weight: 600;
            letter-spacing: 0.1em;
            color: var(--text-muted);
            text-transform: uppercase;
            margin: 0 0 10px;
        }

        /* ‚îÄ‚îÄ MAP ‚îÄ‚îÄ */
        #map { flex: 1; height: 100vh; min-width: 0; }

        /* ‚îÄ‚îÄ CONTACT LIST ‚îÄ‚îÄ */
        #contact-list {
            width: 310px;
            min-width: 310px;
            height: 100vh;
            background: var(--sidebar-bg);
            border-left: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        .contact-list-header {
            padding: 16px;
            border-bottom: 1px solid var(--border);
            background: linear-gradient(180deg, #1e293b 0%, #162032 100%);
            position: sticky;
            top: 0;
            flex-shrink: 0;
        }
        #contacts-scroll {
            flex: 1;
            overflow-y: auto;
            padding: 12px;
        }
        #contacts-scroll::-webkit-scrollbar { width: 4px; }
        #contacts-scroll::-webkit-scrollbar-track { background: transparent; }
        #contacts-scroll::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }

        /* ‚îÄ‚îÄ STATS ‚îÄ‚îÄ */
        .contact-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin-bottom: 12px;
        }
        .stat-card {
            background: var(--card-bg);
            padding: 10px 12px;
            border-radius: 10px;
            text-align: center;
            border: 1px solid var(--border);
        }
        .stat-value { display: block; font-size: 1.4rem; font-weight: 700; color: var(--primary); }
        .stat-label { display: block; font-size: 0.65rem; color: var(--text-muted); margin-top: 1px; }

        /* ‚îÄ‚îÄ SEARCH ‚îÄ‚îÄ */
        .search-wrapper {
            position: relative;
            margin-bottom: 10px;
        }
        .search-wrapper svg {
            position: absolute;
            left: 10px;
            top: 50%;
            transform: translateY(-50%);
            width: 14px;
            height: 14px;
            stroke: var(--text-muted);
        }
        .search-wrapper input {
            width: 100%;
            padding: 8px 8px 8px 34px;
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text);
            font-size: 0.8rem;
            font-family: inherit;
        }
        .search-wrapper input::placeholder { color: var(--text-muted); }
        .search-wrapper input:focus { outline: none; border-color: var(--primary); }

        /* ‚îÄ‚îÄ BUTTONS ‚îÄ‚îÄ */
        .btn {
            padding: 9px 14px;
            border-radius: 8px;
            font-size: 0.75rem;
            font-weight: 600;
            cursor: pointer;
            border: 1px solid;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            transition: all 0.2s;
            font-family: inherit;
            text-align: center;
            justify-content: center;
        }
        .btn-primary { background: var(--primary); color: white; border-color: var(--primary); }
        .btn-primary:hover { background: var(--primary-hover); }
        .btn-secondary { background: transparent; color: var(--text); border-color: var(--border); }
        .btn-secondary:hover { background: var(--card-bg); }
        .btn-success { background: var(--success); color: white; border-color: var(--success); }
        .btn-danger { background: var(--danger); color: white; border-color: var(--danger); }

        .action-btns {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
        }
        .action-btns .btn { flex: 1; min-width: 0; }

        /* ‚îÄ‚îÄ FILTERS ‚îÄ‚îÄ */
        .filter-group {
            margin-bottom: 14px;
        }
        .filter-label {
            font-size: 0.7rem;
            font-weight: 600;
            color: var(--text-muted);
            margin-bottom: 6px;
            display: block;
        }
        .filter-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
        }
        .filter-tag {
            padding: 5px 10px;
            border-radius: 6px;
            font-size: 0.7rem;
            cursor: pointer;
            background: var(--card-bg);
            color: var(--text-muted);
            border: 1px solid var(--border);
            transition: all 0.15s;
            font-weight: 500;
        }
        .filter-tag:hover { background: var(--card-hover); }
        .filter-tag.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
            font-weight: 600;
        }

        .checkbox-group {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }
        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 10px;
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.15s;
            font-size: 0.75rem;
        }
        .checkbox-item:hover { background: var(--card-hover); }
        .checkbox-item input[type="checkbox"] {
            width: 14px;
            height: 14px;
            cursor: pointer;
            accent-color: var(--primary);
        }
        .checkbox-item.active {
            background: rgba(99, 102, 241, 0.15);
            border-color: var(--primary);
        }

        /* ‚îÄ‚îÄ CONTACT CARD ‚îÄ‚îÄ */
        .contact-card {
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 12px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .contact-card:hover { background: var(--card-hover); transform: translateY(-1px); }
        .contact-card.selected {
            border-color: var(--primary);
            box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.2);
        }

        .contact-name {
            font-weight: 700;
            font-size: 0.85rem;
            margin-bottom: 3px;
            color: var(--text);
        }
        .contact-company {
            font-size: 0.7rem;
            color: var(--primary);
            margin-bottom: 6px;
        }
        .contact-info {
            font-size: 0.68rem;
            color: var(--text-muted);
            line-height: 1.5;
        }
        .contact-info-item {
            display: flex;
            align-items: center;
            gap: 5px;
            margin-bottom: 2px;
        }
        .contact-info-item svg {
            width: 11px;
            height: 11px;
            flex-shrink: 0;
        }

        .contact-badges {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
            margin-top: 8px;
        }
        .badge {
            padding: 3px 7px;
            border-radius: 5px;
            font-size: 0.6rem;
            font-weight: 600;
            border: 1px solid;
        }
        .badge-region { background: rgba(34, 197, 94, 0.15); color: var(--success); border-color: var(--success); }
        .badge-national { background: rgba(245, 158, 11, 0.15); color: var(--warning); border-color: var(--warning); }
        .badge-france { background: rgba(99, 102, 241, 0.15); color: var(--primary); border-color: var(--primary); }

        /* ZONES DE LIVRAISON - Nouvelles classes */
        .delivery-zones {
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px solid var(--border);
        }
        .delivery-zones-label {
            font-size: 0.6rem;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 5px;
        }
        .delivery-zone-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
        }
        .zone-tag {
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 0.65rem;
            font-weight: 600;
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.2), rgba(139, 92, 252, 0.2));
            color: #a5b4fc;
            border: 1px solid rgba(99, 102, 241, 0.3);
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }
        .zone-tag::before {
            content: 'üì¶';
            font-size: 0.7rem;
        }

        /* ‚îÄ‚îÄ MODAL ‚îÄ‚îÄ */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.75);
            z-index: 2000;
            display: none;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(4px);
        }
        .modal-overlay.visible { display: flex; }

        .modal {
            background: var(--sidebar-bg);
            border: 1px solid var(--border);
            border-radius: 20px;
            padding: 28px;
            max-width: 550px;
            width: 90%;
            max-height: 85vh;
            overflow-y: auto;
            box-shadow: 0 32px 64px rgba(0,0,0,0.5);
            animation: modalIn 0.2s ease;
        }
        @keyframes modalIn { from { opacity: 0; transform: scale(0.95); } }

        .modal::-webkit-scrollbar { width: 6px; }
        .modal::-webkit-scrollbar-track { background: transparent; }
        .modal::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        .modal-title {
            font-size: 1.2rem;
            font-weight: 700;
            background: linear-gradient(135deg, #818cf8, #c084fc);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .modal-close {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            background: transparent;
            border: 1px solid var(--border);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.15s;
            color: var(--text-muted);
        }
        .modal-close:hover { background: var(--card-bg); color: var(--text); }

        .form-group {
            margin-bottom: 16px;
        }
        .form-label {
            display: block;
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--text-muted);
            margin-bottom: 6px;
        }
        .form-control {
            width: 100%;
            padding: 10px 12px;
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text);
            font-size: 0.85rem;
            font-family: inherit;
        }
        .form-control::placeholder { color: var(--text-muted); }
        .form-control:focus { outline: none; border-color: var(--primary); }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        /* Zones de livraison dans le formulaire */
        .delivery-zone-input {
            margin-top: 12px;
            padding: 12px;
            background: rgba(99, 102, 241, 0.05);
            border: 1px solid rgba(99, 102, 241, 0.2);
            border-radius: 8px;
        }
        .delivery-zone-input-label {
            font-size: 0.7rem;
            font-weight: 600;
            color: var(--primary);
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .delivery-zone-input-label::before {
            content: 'üì¶';
        }
        .delivery-zone-input input {
            background: var(--card-bg);
        }
        .delivery-zone-help {
            font-size: 0.65rem;
            color: var(--text-muted);
            margin-top: 4px;
            font-style: italic;
        }

        .modal-actions {
            display: flex;
            gap: 10px;
            margin-top: 24px;
        }
        .modal-actions .btn { flex: 1; }

        /* ‚îÄ‚îÄ TOAST ‚îÄ‚îÄ */
        .toast {
            position: fixed;
            bottom: 24px;
            right: 24px;
            background: var(--sidebar-bg);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 14px 18px;
            z-index: 5000;
            box-shadow: 0 12px 32px rgba(0,0,0,0.4);
            animation: toastIn 0.3s ease;
            max-width: 380px;
            font-size: 0.85rem;
        }
        @keyframes toastIn { from { opacity: 0; transform: translateY(20px); } }
        .toast.success { border-left: 3px solid var(--success); }
        .toast.error { border-left: 3px solid var(--danger); }

        /* ‚îÄ‚îÄ BACK TO TOP ‚îÄ‚îÄ */
        #back-top-btn {
            position: fixed;
            bottom: 24px;
            right: 24px;
            width: 48px;
            height: 48px;
            background: var(--primary);
            border: none;
            border-radius: 50%;
            cursor: pointer;
            display: none;
            align-items: center;
            justify-content: center;
            box-shadow: 0 8px 24px rgba(99, 102, 241, 0.4);
            transition: all 0.3s;
            z-index: 1000;
        }
        #back-top-btn.visible { display: flex; }
        #back-top-btn:hover { background: var(--primary-hover); transform: translateY(-2px); }
        #back-top-btn svg { width: 20px; height: 20px; stroke: white; stroke-width: 2.5; }

        /* ‚îÄ‚îÄ LEAFLET CUSTOM ‚îÄ‚îÄ */
        .leaflet-popup-content-wrapper {
            background: var(--sidebar-bg);
            color: var(--text);
            border-radius: 12px;
            border: 1px solid var(--border);
            box-shadow: 0 12px 32px rgba(0,0,0,0.4);
        }
        .leaflet-popup-tip { background: var(--sidebar-bg); }
        .leaflet-popup-content {
            margin: 14px;
            font-family: 'Inter', sans-serif;
        }

        /* CUSTOM CLUSTER ICONS - Regrouper uniquement par ville */
        .marker-cluster-city {
            background: rgba(99, 102, 241, 0.2);
            border: 2px solid var(--primary);
            border-radius: 50%;
            color: white;
            font-weight: 700;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
        }
        .marker-cluster-city div {
            background: var(--primary);
            border-radius: 50%;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Marker pour contacts "Toute France" */
        .marker-france {
            background: linear-gradient(135deg, #6366f1, #8b5cf6);
            border: 3px solid white;
            border-radius: 50%;
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.5);
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
        }
    </style>
</head>
<body>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<!-- LOGIN -->
<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="login-overlay">
    <div class="login-box">
        <div class="login-logo">
            <span>AzimutTrans</span>
            <p>Cartographie Contacts</p>
        </div>
        <form onsubmit="handleLogin(event)">
            <div class="form-group">
                <label class="form-label">Nom d'utilisateur</label>
                <input type="text" id="login-username" class="form-control" placeholder="Votre identifiant" required>
            </div>
            <div class="form-group">
                <label class="form-label">Mot de passe</label>
                <input type="password" id="login-password" class="form-control" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required>
            </div>
            <button type="submit" class="btn btn-primary" style="width: 100%; margin-top: 8px;">
                Se connecter
            </button>
        </form>
    </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<!-- MAIN CONTENT -->
<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="main-content">
    <!-- ‚îÄ‚îÄ SIDEBAR ‚îÄ‚îÄ -->
    <aside id="sidebar">
        <div class="sidebar-header">
            <h1>AzimutTrans</h1>
            <p>Gestion de contacts</p>
        </div>

        <!-- Stats -->
        <div class="sidebar-section">
            <div class="contact-stats">
                <div class="stat-card">
                    <span class="stat-value" id="stat-total">0</span>
                    <span class="stat-label">TOTAL</span>
                </div>
                <div class="stat-card">
                    <span class="stat-value" id="stat-visible">0</span>
                    <span class="stat-label">VISIBLES</span>
                </div>
            </div>
        </div>

        <!-- Actions -->
        <div class="sidebar-section">
            <div class="sidebar-section-title">Actions</div>
            <div class="action-btns">
                <button class="btn btn-primary" onclick="openAddModal()">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" width="14" height="14"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/></svg>
                    Ajouter
                </button>
                <button class="btn btn-secondary" onclick="document.getElementById('import-excel').click()">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" width="14" height="14"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/></svg>
                    Import
                </button>
                <input type="file" id="import-excel" accept=".xlsx,.xls" style="display:none" onchange="importExcel(this)">
            </div>
            <div class="action-btns" style="margin-top: 6px;">
                <button class="btn btn-success" onclick="exportExcel()">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" width="14" height="14"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>
                    Export
                </button>
                <button class="btn btn-danger" onclick="confirmDeleteAll()">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" width="14" height="14"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>
                    Tout suppr.
                </button>
            </div>
        </div>

        <!-- Filtres R√©gions -->
        <div class="sidebar-section">
            <div class="sidebar-section-title">R√©gions</div>
            <div class="filter-tags" id="region-filters"></div>
        </div>

        <!-- Filtres Zones de livraison -->
        <div class="sidebar-section">
            <div class="sidebar-section-title">Zones de livraison (fret)</div>
            <div class="filter-tags" id="delivery-zone-filters"></div>
        </div>

        <!-- Filtres Scope -->
        <div class="sidebar-section">
            <div class="sidebar-section-title">P√©rim√®tre</div>
            <div class="checkbox-group">
                <label class="checkbox-item" id="scope-regional-check">
                    <input type="checkbox" onchange="toggleScopeFilter('regional')">
                    <span>R√©gional</span>
                </label>
                <label class="checkbox-item" id="scope-national-check">
                    <input type="checkbox" onchange="toggleScopeFilter('national')">
                    <span>National</span>
                </label>
                <label class="checkbox-item" id="scope-france-check">
                    <input type="checkbox" onchange="toggleScopeFilter('france')">
                    <span>üá´üá∑ Toute France</span>
                </label>
            </div>
        </div>
    </aside>

    <!-- ‚îÄ‚îÄ MAP ‚îÄ‚îÄ -->
    <div id="map"></div>

    <!-- ‚îÄ‚îÄ CONTACT LIST ‚îÄ‚îÄ -->
    <aside id="contact-list">
        <div class="contact-list-header">
            <div class="search-wrapper">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg>
                <input type="text" id="contact-search" placeholder="Rechercher..." oninput="filterContacts()">
            </div>
        </div>
        <div id="contacts-scroll"></div>
    </aside>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<!-- MODAL CONTACT -->
<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="modal-overlay" id="contact-modal">
    <div class="modal">
        <div class="modal-header">
            <div class="modal-title" id="modal-title">Ajouter un contact</div>
            <button class="modal-close" onclick="closeModal()">‚úï</button>
        </div>
        <form id="contact-form" onsubmit="saveContact(event)">
            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">Pr√©nom *</label>
                    <input type="text" id="f-firstName" class="form-control" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Nom</label>
                    <input type="text" id="f-lastName" class="form-control">
                </div>
            </div>
            <div class="form-group">
                <label class="form-label">Entreprise</label>
                <input type="text" id="f-company" class="form-control">
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">Email</label>
                    <input type="email" id="f-email" class="form-control">
                </div>
                <div class="form-group">
                    <label class="form-label">T√©l√©phone</label>
                    <input type="tel" id="f-phone" class="form-control">
                </div>
            </div>
            <div class="form-group">
                <label class="form-label">Ville</label>
                <input type="text" id="f-city" class="form-control" placeholder="Laissez vide pour 'Toute France'">
                <small class="delivery-zone-help">Si vide, le contact sera marqu√© "Toute France"</small>
            </div>
            
            <div class="delivery-zone-input">
                <div class="delivery-zone-input-label">
                    Zones de livraison (fret)
                </div>
                <input type="text" id="f-deliveryZone" class="form-control" placeholder="Ex: Auvergne-Rh√¥ne-Alpes, Occitanie, Nouvelle-Aquitaine">
                <div class="delivery-zone-help">S√©parez les zones par des virgules. Ces zones repr√©sentent o√π le contact peut fournir du fret.</div>
            </div>

            <div class="form-group" style="margin-top: 16px;">
                <label class="form-label">R√©gion (auto-d√©tect√©e)</label>
                <input type="text" id="f-region" class="form-control" readonly>
            </div>

            <div class="checkbox-group" style="margin-top: 16px;">
                <label class="checkbox-item">
                    <input type="checkbox" id="f-scopeRegional">
                    <span>P√©rim√®tre R√©gional</span>
                </label>
                <label class="checkbox-item">
                    <input type="checkbox" id="f-scopeNational">
                    <span>P√©rim√®tre National</span>
                </label>
            </div>

            <div class="modal-actions">
                <button type="button" class="btn btn-secondary" onclick="closeModal()">Annuler</button>
                <button type="submit" class="btn btn-primary" id="modal-submit-btn">Enregistrer</button>
            </div>
        </form>
    </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<!-- BACK TO TOP BUTTON -->
<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<button id="back-top-btn" onclick="scrollToTop()">
    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M5 10l7-7m0 0l7 7m-7-7v18"/></svg>
</button>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<!-- SCRIPTS -->
<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// GLOBAL VARIABLES
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let contacts = [];
let map, markerLayer;
let currentEditingId = null;

const regionCoords = {
    '√éle-de-France': [48.8566, 2.3522],
    'Auvergne-Rh√¥ne-Alpes': [45.4642, 4.3898],
    'Provence-Alpes-C√¥te d\'Azur': [43.9352, 6.0679],
    'Occitanie': [43.6047, 1.4442],
    'Nouvelle-Aquitaine': [44.8378, -0.5792],
    'Pays de la Loire': [47.2184, -1.5536],
    'Bretagne': [48.1173, -1.6778],
    'Normandie': [49.1829, -0.3707],
    'Hauts-de-France': [50.6292, 3.0573],
    'Grand Est': [48.5734, 7.7521],
    'Bourgogne-Franche-Comt√©': [47.2805, 5.0414],
    'Centre-Val de Loire': [47.9029, 1.9093],
    'Corse': [42.0396, 9.0129]
};

const filters = {
    regions: new Set(),
    deliveryZones: new Set(),
    scopes: new Set(),
    search: ''
};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// LOGIN
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function handleLogin(e) {
    e.preventDefault();
    const username = document.getElementById('login-username').value;
    const password = document.getElementById('login-password').value;

    if (username === 'AzimutTrans' && password === 'Azimut73') {
        document.getElementById('login-overlay').style.display = 'none';
        document.getElementById('main-content').classList.add('visible');
        initApp();
    } else {
        toast('Identifiants incorrects', 'error');
    }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// INIT APP
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function initApp() {
    await loadFromServer();
    initMap();
    refreshUI();
    initBackToTopBtn();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// MAP
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function initMap() {
    map = L.map('map').setView([46.603354, 1.888334], 6);
    L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
        attribution: '¬© OpenStreetMap',
        maxZoom: 19
    }).addTo(map);

    // Cluster avec regroupement uniquement par ville
    markerLayer = L.markerClusterGroup({
        iconCreateFunction: function(cluster) {
            const markers = cluster.getAllChildMarkers();
            const cities = new Set(markers.map(m => m.options.city));
            
            // Si tous les marqueurs sont de la m√™me ville, on affiche un cluster
            if (cities.size === 1) {
                const count = markers.length;
                return L.divIcon({
                    html: `<div><span>${count}</span></div>`,
                    className: 'marker-cluster-city',
                    iconSize: L.point(40, 40)
                });
            }
            // Sinon, on ne groupe pas (chaque ville reste s√©par√©e)
            return null;
        },
        maxClusterRadius: 40, // R√©duire le rayon pour grouper uniquement les marqueurs tr√®s proches
        disableClusteringAtZoom: 10,
        spiderfyOnMaxZoom: true,
        showCoverageOnHover: false
    });
    map.addLayer(markerLayer);
}

function refreshMap() {
    markerLayer.clearLayers();
    const visible = getFilteredContacts();

    // Contacts avec ville
    visible.filter(c => c.lat && c.lon).forEach(c => {
        const marker = L.marker([c.lat, c.lon], { city: c.city || '' });
        marker.bindPopup(buildPopup(c));
        marker.on('click', () => selectContact(c.id));
        markerLayer.addLayer(marker);
    });

    // Contacts "Toute France" - affich√©s au centre de la France
    const franceCentre = [46.603354, 1.888334];
    visible.filter(c => !c.lat && !c.lon && !c.city).forEach((c, index) => {
        // L√©g√®re dispersion pour √©viter les superpositions
        const offsetLat = (Math.random() - 0.5) * 0.5;
        const offsetLon = (Math.random() - 0.5) * 0.5;
        
        const marker = L.marker([franceCentre[0] + offsetLat, franceCentre[1] + offsetLon], {
            icon: L.divIcon({
                html: 'üá´üá∑',
                className: 'marker-france',
                iconSize: L.point(32, 32)
            }),
            city: 'Toute France'
        });
        marker.bindPopup(buildPopup(c));
        marker.on('click', () => selectContact(c.id));
        markerLayer.addLayer(marker);
    });
}

function buildPopup(c) {
    const zones = c.deliveryZone ? c.deliveryZone.split(',').map(z => z.trim()).filter(Boolean) : [];
    const zoneHTML = zones.length > 0 ? 
        `<div style="margin-top:8px;padding-top:8px;border-top:1px solid #334155;">
            <div style="font-size:0.65rem;color:#94a3b8;font-weight:600;margin-bottom:4px;">üì¶ ZONES DE LIVRAISON (FRET)</div>
            ${zones.map(z => `<span style="display:inline-block;padding:3px 7px;background:rgba(99,102,241,0.2);color:#a5b4fc;border-radius:5px;font-size:0.65rem;margin:2px;">${z}</span>`).join('')}
        </div>` : '';

    return `
        <div style="min-width:200px;font-family:'Inter',sans-serif;">
            <div style="font-size:0.95rem;font-weight:700;margin-bottom:4px;">${c.firstName} ${c.lastName || ''}</div>
            ${c.company ? `<div style="font-size:0.75rem;color:#6366f1;margin-bottom:6px;">${c.company}</div>` : ''}
            ${c.city ? `<div style="font-size:0.7rem;color:#94a3b8;margin-bottom:2px;">üìç ${c.fullName || c.city}</div>` : '<div style="font-size:0.7rem;color:#6366f1;font-weight:600;">üá´üá∑ Toute France</div>'}
            ${c.email ? `<div style="font-size:0.7rem;color:#94a3b8;">‚úâÔ∏è ${c.email}</div>` : ''}
            ${c.phone ? `<div style="font-size:0.7rem;color:#94a3b8;">üì± ${c.phone}</div>` : ''}
            ${zoneHTML}
        </div>
    `;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// UI REFRESH
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function refreshUI() {
    updateStats();
    updateFilters();
    refreshMap();
    renderContactList();
}

function updateStats() {
    document.getElementById('stat-total').textContent = contacts.length;
    document.getElementById('stat-visible').textContent = getFilteredContacts().length;
}

function updateFilters() {
    // R√©gions
    const regions = [...new Set(contacts.map(c => c.region).filter(Boolean))].sort();
    const regionsHTML = regions.map(r => 
        `<div class="filter-tag ${filters.regions.has(r) ? 'active' : ''}" onclick="toggleRegionFilter('${r}')">${r}</div>`
    ).join('');
    document.getElementById('region-filters').innerHTML = regionsHTML;

    // Zones de livraison
    const allZones = new Set();
    contacts.forEach(c => {
        if (c.deliveryZone) {
            c.deliveryZone.split(',').forEach(z => {
                const zone = z.trim();
                if (zone) allZones.add(zone);
            });
        }
    });
    const zones = [...allZones].sort();
    const zonesHTML = zones.map(z => 
        `<div class="filter-tag ${filters.deliveryZones.has(z) ? 'active' : ''}" onclick="toggleDeliveryZoneFilter('${z}')">${z}</div>`
    ).join('');
    document.getElementById('delivery-zone-filters').innerHTML = zonesHTML || '<div style="font-size:0.7rem;color:#94a3b8;">Aucune zone</div>';
}

function renderContactList() {
    const visible = getFilteredContacts();
    const html = visible.map(c => {
        const zones = c.deliveryZone ? c.deliveryZone.split(',').map(z => z.trim()).filter(Boolean) : [];
        const zonesHTML = zones.length > 0 ? 
            `<div class="delivery-zones">
                <div class="delivery-zones-label">Zones de livraison</div>
                <div class="delivery-zone-tags">
                    ${zones.map(z => `<span class="zone-tag">${z}</span>`).join('')}
                </div>
            </div>` : '';

        const isFrance = !c.city && !c.lat && !c.lon;

        return `
            <div class="contact-card" onclick="selectContact('${c.id}')">
                <div class="contact-name">${c.firstName} ${c.lastName || ''}</div>
                ${c.company ? `<div class="contact-company">${c.company}</div>` : ''}
                <div class="contact-info">
                    ${c.city ? `<div class="contact-info-item">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
                        ${c.fullName || c.city}
                    </div>` : ''}
                    ${c.email ? `<div class="contact-info-item">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/></svg>
                        ${c.email}
                    </div>` : ''}
                    ${c.phone ? `<div class="contact-info-item">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"/></svg>
                        ${c.phone}
                    </div>` : ''}
                </div>
                <div class="contact-badges">
                    ${c.scopeRegional ? '<span class="badge badge-region">R√©gional</span>' : ''}
                    ${c.scopeNational ? '<span class="badge badge-national">National</span>' : ''}
                    ${isFrance ? '<span class="badge badge-france">üá´üá∑ Toute France</span>' : ''}
                </div>
                ${zonesHTML}
            </div>
        `;
    }).join('');
    document.getElementById('contacts-scroll').innerHTML = html || '<div style="padding:20px;text-align:center;color:#94a3b8;font-size:0.8rem;">Aucun contact</div>';
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// FILTERS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function toggleRegionFilter(region) {
    if (filters.regions.has(region)) filters.regions.delete(region);
    else filters.regions.add(region);
    refreshUI();
}

function toggleDeliveryZoneFilter(zone) {
    if (filters.deliveryZones.has(zone)) filters.deliveryZones.delete(zone);
    else filters.deliveryZones.add(zone);
    refreshUI();
}

function toggleScopeFilter(scope) {
    if (filters.scopes.has(scope)) {
        filters.scopes.delete(scope);
        document.getElementById(`scope-${scope}-check`).classList.remove('active');
    } else {
        filters.scopes.add(scope);
        document.getElementById(`scope-${scope}-check`).classList.add('active');
    }
    refreshUI();
}

function filterContacts() {
    filters.search = document.getElementById('contact-search').value.toLowerCase();
    refreshUI();
}

function getFilteredContacts() {
    return contacts.filter(c => {
        // Recherche
        if (filters.search) {
            const searchable = `${c.firstName} ${c.lastName} ${c.company} ${c.city} ${c.email}`.toLowerCase();
            if (!searchable.includes(filters.search)) return false;
        }

        // R√©gions
        if (filters.regions.size > 0 && !filters.regions.has(c.region)) return false;

        // Zones de livraison
        if (filters.deliveryZones.size > 0) {
            const contactZones = c.deliveryZone ? c.deliveryZone.split(',').map(z => z.trim()) : [];
            const hasZone = contactZones.some(z => filters.deliveryZones.has(z));
            if (!hasZone) return false;
        }

        // Scopes
        if (filters.scopes.size > 0) {
            const isFrance = !c.city && !c.lat && !c.lon;
            if (filters.scopes.has('regional') && !c.scopeRegional) return false;
            if (filters.scopes.has('national') && !c.scopeNational) return false;
            if (filters.scopes.has('france') && !isFrance) return false;
        }

        return true;
    });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CONTACT SELECTION
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function selectContact(id) {
    const c = contacts.find(x => x.id === id);
    if (!c) return;

    document.querySelectorAll('.contact-card').forEach(card => card.classList.remove('selected'));
    event.target.closest('.contact-card')?.classList.add('selected');

    if (c.lat && c.lon) {
        map.setView([c.lat, c.lon], 12);
    }

    openEditModal(c);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// MODAL
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function openAddModal() {
    currentEditingId = null;
    document.getElementById('modal-title').textContent = 'Ajouter un contact';
    document.getElementById('contact-form').reset();
    document.getElementById('modal-submit-btn').textContent = 'Enregistrer';
    document.getElementById('contact-modal').classList.add('visible');
}

function openEditModal(c) {
    currentEditingId = c.id;
    document.getElementById('modal-title').textContent = 'Modifier le contact';
    document.getElementById('f-firstName').value = c.firstName || '';
    document.getElementById('f-lastName').value = c.lastName || '';
    document.getElementById('f-company').value = c.company || '';
    document.getElementById('f-email').value = c.email || '';
    document.getElementById('f-phone').value = c.phone || '';
    document.getElementById('f-city').value = c.city || '';
    document.getElementById('f-region').value = c.region || '';
    document.getElementById('f-deliveryZone').value = c.deliveryZone || '';
    document.getElementById('f-scopeRegional').checked = c.scopeRegional || false;
    document.getElementById('f-scopeNational').checked = c.scopeNational || false;
    document.getElementById('modal-submit-btn').textContent = 'Mettre √† jour';
    document.getElementById('contact-modal').classList.add('visible');
}

function closeModal() {
    document.getElementById('contact-modal').classList.remove('visible');
    document.querySelectorAll('.contact-card').forEach(card => card.classList.remove('selected'));
}

async function saveContact(e) {
    e.preventDefault();

    const firstName = document.getElementById('f-firstName').value.trim();
    const lastName = document.getElementById('f-lastName').value.trim();
    const company = document.getElementById('f-company').value.trim();
    const email = document.getElementById('f-email').value.trim();
    const phone = document.getElementById('f-phone').value.trim();
    const city = document.getElementById('f-city').value.trim();
    const deliveryZone = document.getElementById('f-deliveryZone').value.trim();
    const scopeRegional = document.getElementById('f-scopeRegional').checked;
    const scopeNational = document.getElementById('f-scopeNational').checked;

    let lat = null, lon = null, fullName = '', region = '';

    if (city) {
        const coords = await geocode(city);
        if (coords) {
            lat = coords.lat;
            lon = coords.lon;
            fullName = coords.fullName;
            region = await findRegion(lat, lon);
            document.getElementById('f-region').value = region;
        } else {
            toast('Impossible de g√©ocoder la ville', 'error');
            return;
        }
    }

    const contactData = { firstName, lastName, company, email, phone, city, region, deliveryZone, scopeRegional, scopeNational, lat, lon, fullName };

    if (currentEditingId) {
        const idx = contacts.findIndex(c => c.id === currentEditingId);
        if (idx >= 0) contacts[idx] = { ...contacts[idx], ...contactData };
        toast('Contact mis √† jour');
    } else {
        contacts.push({ id: Date.now().toString(), ...contactData });
        toast('Contact ajout√©');
    }

    await saveToServer();
    refreshUI();
    closeModal();
}

async function confirmDeleteAll() {
    if (!confirm('Supprimer tous les contacts ?')) return;
    contacts = [];
    await saveToServer();
    refreshUI();
    toast('Tous les contacts supprim√©s', 'error');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// GEOCODING
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function geocode(city) {
    try {
        const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(city)},France&limit=1`);
        const data = await res.json();
        if (data.length > 0) {
            return {
                lat: parseFloat(data[0].lat),
                lon: parseFloat(data[0].lon),
                fullName: data[0].display_name
            };
        }
    } catch (err) {
        console.error('Geocode error:', err);
    }
    return null;
}

async function findRegion(lat, lon) {
    let closest = '';
    let minDist = Infinity;
    for (const [name, coords] of Object.entries(regionCoords)) {
        const dist = Math.sqrt(Math.pow(lat - coords[0], 2) + Math.pow(lon - coords[1], 2));
        if (dist < minDist) {
            minDist = dist;
            closest = name;
        }
    }
    return closest;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SERVER SYNC
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function saveToServer() {
    try {
        await fetch('/api/contacts', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(contacts)
        });
    } catch (err) {
        console.error('Save error:', err);
    }
}

async function loadFromServer() {
    try {
        const res = await fetch('/api/contacts');
        if (res.ok) contacts = await res.json();
    } catch (err) {
        console.error('Load error:', err);
    }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// EXPORT EXCEL
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function exportExcel() {
    const data = contacts.map(c => ({
        'Pr√©nom': c.firstName,
        'Nom': c.lastName || '',
        'Entreprise': c.company || '',
        'Email': c.email || '',
        'T√©l√©phone': c.phone || '',
        'Ville': c.city || '',
        'R√©gion': c.region || '',
        'Zones de livraison': c.deliveryZone || '',
        'Scope': (c.scopeRegional ? 'R√©gional ' : '') + (c.scopeNational ? 'National' : ''),
        'Latitude': c.lat || '',
        'Longitude': c.lon || ''
    }));

    const ws = XLSX.utils.json_to_sheet(data);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, 'Contacts');
    XLSX.writeFile(wb, `contacts_${new Date().toISOString().split('T')[0]}.xlsx`);
    toast('Export r√©ussi');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// TOAST
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function toast(msg, type = 'success') {
    const el = document.createElement('div');
    el.className = `toast ${type}`;
    el.textContent = msg;
    document.body.appendChild(el);
    setTimeout(() => el.remove(), 3000);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// IMPORT EXCEL
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function parseScope(s) {
    if (!s) return { scopeRegional: false, scopeNational: false };
    const l = s.toString().toLowerCase();
    return {
        scopeRegional: l.includes('r√©gional') || l.includes('regional'),
        scopeNational: l.includes('national')
    };
}

function showImportProgress(msg, current, total) {
    let el = document.getElementById('import-progress-container');
    if (!el) {
        el = document.createElement('div');
        el.id = 'import-progress-container';
        el.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.75);z-index:9999;display:flex;align-items:center;justify-content:center;';
        el.innerHTML = `
            <div style="background:#1e293b;border:1px solid #334155;border-radius:16px;padding:32px;min-width:380px;text-align:center;">
                <div style="font-size:1rem;font-weight:600;color:#f1f5f9;margin-bottom:6px;" id="imp-msg"></div>
                <div style="font-size:0.75rem;color:#94a3b8;margin-bottom:16px;" id="imp-count"></div>
                <div style="background:#334155;border-radius:999px;height:8px;overflow:hidden;">
                    <div id="imp-bar" style="background:linear-gradient(90deg,#6366f1,#8b5cf6);height:100%;width:0%;transition:width 0.3s ease;border-radius:999px;"></div>
                </div>
            </div>`;
        document.body.appendChild(el);
    }
    const pct = total > 0 ? Math.round((current / total) * 100) : 0;
    document.getElementById('imp-bar').style.width = pct + '%';
    document.getElementById('imp-msg').textContent   = msg;
    document.getElementById('imp-count').textContent = `${current} / ${total}`;
}

function hideImportProgress() {
    const el = document.getElementById('import-progress-container');
    if (el) el.remove();
}

function showImportChoiceDialog(existingCount, newCount) {
    return new Promise(resolve => {
        const ov = document.createElement('div');
        ov.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.8);z-index:10000;display:flex;align-items:center;justify-content:center;backdrop-filter:blur(4px);';
        ov.innerHTML = `
            <div style="background:#1e293b;border:1px solid #334155;border-radius:18px;padding:32px;max-width:420px;width:90%;font-family:'Inter',sans-serif;animation:modalIn 0.2s ease;">
                <div style="font-size:1.5rem;margin-bottom:8px;">üìÇ</div>
                <div style="font-size:1rem;font-weight:700;color:#f1f5f9;margin-bottom:8px;">Import Excel</div>
                <p style="color:#94a3b8;font-size:0.85rem;margin:0 0 20px;line-height:1.5;">
                    Base actuelle : <strong style="color:#f1f5f9">${existingCount} contact(s)</strong><br>
                    Fichier : <strong style="color:#f1f5f9">${newCount} ligne(s)</strong><br>
                    Que souhaitez-vous faire ?
                </p>
                <div style="display:flex;flex-direction:column;gap:8px;">
                    <button id="bi-replace" style="background:#7f1d1d;color:#f87171;border:1px solid #991b1b;border-radius:10px;padding:12px 16px;cursor:pointer;font-size:0.85rem;font-weight:600;text-align:left;font-family:'Inter',sans-serif;">
                        üóëÔ∏è Remplacer ‚Äî Supprimer les anciens et importer
                    </button>
                    <button id="bi-merge" style="background:#1e3a5f;color:#60a5fa;border:1px solid #1d4ed8;border-radius:10px;padding:12px 16px;cursor:pointer;font-size:0.85rem;font-weight:600;text-align:left;font-family:'Inter',sans-serif;">
                        üîÑ Fusionner ‚Äî Mettre √† jour les existants + nouveaux
                    </button>
                    <button id="bi-cancel" style="background:transparent;color:#94a3b8;border:1px solid #475569;border-radius:10px;padding:10px 16px;cursor:pointer;font-size:0.82rem;font-family:'Inter',sans-serif;">
                        Annuler
                    </button>
                </div>
            </div>`;
        document.body.appendChild(ov);
        ov.querySelector('#bi-replace').onclick = () => { ov.remove(); resolve('replace'); };
        ov.querySelector('#bi-merge').onclick   = () => { ov.remove(); resolve('merge');   };
        ov.querySelector('#bi-cancel').onclick  = () => { ov.remove(); resolve(null);      };
    });
}

async function importExcel(input) {
    const file = input.files[0];
    if (!file) return;
    input.value = '';

    const reader = new FileReader();
    reader.onload = async (e) => {
        try {
            const wb = XLSX.read(new Uint8Array(e.target.result), { type: 'array' });
            const contactCols = ['city', 'first_name', 'ville', 'prenom'];
            let sheetName = wb.SheetNames[0];
            for (const name of wb.SheetNames) {
                const rows0 = XLSX.utils.sheet_to_json(wb.Sheets[name], { header: 1 });
                if (rows0.length > 0) {
                    const headers = (rows0[0] || []).map(h => String(h || '').toLowerCase().trim());
                    if (contactCols.some(c => headers.includes(c))) { sheetName = name; break; }
                }
            }

            const rows = XLSX.utils.sheet_to_json(wb.Sheets[sheetName]);
            if (!rows.length) { toast('Fichier vide ou format incorrect', 'error'); return; }

            let mergeMode = 'replace';
            if (contacts.length > 0) {
                const choice = await showImportChoiceDialog(contacts.length, rows.length);
                if (choice === null) return;
                mergeMode = choice;
            }

            let added = 0, updated = 0, skipped = 0;
            if (mergeMode === 'replace') contacts = [];

            showImportProgress('D√©marrage...', 0, rows.length);

            for (let i = 0; i < rows.length; i++) {
                const row = rows[i];
                const city      = (row.city      || row.City      || row.Ville    || '').toString().trim();
                const firstName = (row.first_name || row['First Name'] || row.Prenom || '').toString().trim();
                const lastName  = (row.last_name  || row['Last Name']  || row.Nom   || '').toString().trim();
                const company   = (row.Company    || row.company   || row.Entreprise || '').toString().trim();
                const email     = (row.email      || row.Email     || '').toString().trim();
                const phone     = (row.phone      || row.Phone     || row.Telephone  || '').toString().trim();
                const regionFF  = (row.Region     || row.region    || '').toString().trim();
                const deliveryZone = (row.delivery_zone || row['Zones de livraison'] || '').toString().trim();
                const { scopeRegional, scopeNational } = parseScope(row.Scope || row.scope || '');

                if (!firstName && !city) { skipped++; showImportProgress('Import...', i+1, rows.length); continue; }

                showImportProgress(`üìç ${city || firstName}...`, i+1, rows.length);

                let lat = null, lon = null, fullName = '', region = regionFF;
                if (city) {
                    const coords = await geocode(city);
                    if (coords) {
                        lat = coords.lat; lon = coords.lon; fullName = coords.fullName;
                        region = await findRegion(lat, lon) || regionFF;
                        await new Promise(r => setTimeout(r, 1100));
                    }
                }

                const nc = { firstName, lastName, email, phone, city, region, company, deliveryZone, scopeRegional, scopeNational, lat, lon, fullName };

                if (mergeMode === 'merge') {
                    const idx = contacts.findIndex(c =>
                        c.firstName.toLowerCase() === firstName.toLowerCase() &&
                        (c.lastName||'').toLowerCase() === lastName.toLowerCase() &&
                        (c.city||'').toLowerCase() === city.toLowerCase()
                    );
                    if (idx >= 0) { contacts[idx] = { ...contacts[idx], ...nc }; updated++; }
                    else { contacts.push({ id: Date.now().toString() + Math.random(), ...nc }); added++; }
                } else {
                    contacts.push({ id: Date.now().toString() + Math.random(), ...nc }); added++;
                }
            }

            showImportProgress('Sauvegarde...', rows.length, rows.length);
            await saveToServer();
            hideImportProgress();
            refreshUI();

            const parts = [`${added} ajout√©(s)`];
            if (updated) parts.push(`${updated} mis √† jour`);
            if (skipped) parts.push(`${skipped} ignor√©(s)`);
            toast(`‚úÖ Import : ${parts.join(' ¬∑ ')}`);

        } catch (err) {
            hideImportProgress();
            toast('Erreur import : ' + err.message, 'error');
            console.error(err);
        }
    };
    reader.readAsArrayBuffer(file);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// BACK TO TOP
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function scrollToTop() {
    document.getElementById('sidebar').scrollTo({ top: 0, behavior: 'smooth' });
    document.getElementById('contacts-scroll').scrollTo({ top: 0, behavior: 'smooth' });
}

function initBackToTopBtn() {
    const btn = document.getElementById('back-top-btn');
    const checkScroll = () => {
        const sb = document.getElementById('sidebar').scrollTop;
        const cs = document.getElementById('contacts-scroll').scrollTop;
        btn.classList.toggle('visible', sb > 150 || cs > 150);
    };
    document.getElementById('sidebar').addEventListener('scroll', checkScroll);
    document.getElementById('contacts-scroll').addEventListener('scroll', checkScroll);
}
</script>
</body>
</html>
