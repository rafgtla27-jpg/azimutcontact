<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Contact Map | Modern</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
    <script src="https://cdn.sheetjs.com/xlsx-0.20.3/package/dist/xlsx.full.min.js"></script>
    <style>
        :root {
            --primary: #6366f1;
            --primary-hover: #4f46e5;
            --bg: #0f172a;
            --sidebar-bg: #1e293b;
            --card-bg: #334155;
            --text: #f8fafc;
            --text-muted: #94a3b8;
            --border: #475569;
            --success: #22c55e;
            --danger: #ef4444;
            --modal-overlay: rgba(0, 0, 0, 0.7);
        }

        body { 
            margin: 0; 
            font-family: 'Inter', sans-serif; 
            display: flex; 
            height: 100vh; 
            background: var(--bg); 
            color: var(--text);
        }

        #login-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--bg);
            z-index: 2000;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .login-box {
            background: var(--sidebar-bg);
            padding: 40px;
            border-radius: 16px;
            width: 100%;
            max-width: 400px;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
            border: 1px solid var(--border);
        }

        #main-content {
            display: none;
            width: 100%;
            height: 100%;
        }
        
        #sidebar { 
            width: 380px; 
            padding: 24px; 
            background: var(--sidebar-bg);
            border-right: 1px solid var(--border); 
            overflow-y: auto; 
            display: flex; 
            flex-direction: column;
            gap: 24px;
            box-shadow: 10px 0 15px -3px rgba(0, 0, 0, 0.1);
            z-index: 10;
        }

        #map { flex-grow: 1; }

        h2 { margin: 0; font-size: 1.25rem; font-weight: 600; color: var(--text); }

        .contact-item { 
            background: rgba(51, 65, 85, 0.4);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            padding: 16px; 
            margin-bottom: 12px; 
            border-radius: 12px; 
            border: 1px solid rgba(71, 85, 105, 0.3);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }
        .contact-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background: var(--company-color, var(--primary));
            transition: width 0.2s ease;
        }
        .contact-item:hover::before { width: 8px; }
        .contact-item:hover {
            background: rgba(51, 65, 85, 0.6);
            transform: translateX(4px);
            border-color: var(--company-color, var(--primary));
        }
        .contact-item h3 { 
            margin: 0 0 4px 0; 
            font-size: 1rem; 
            font-weight: 600;
        }
        .contact-item p { 
            margin: 4px 0; 
            font-size: 0.875rem; 
            color: var(--text-muted);
            word-wrap: break-word;
            overflow-wrap: break-word;
        }

        .contact-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin-bottom: 12px;
        }

        .stat-card {
            background: var(--card-bg);
            padding: 12px;
            border-radius: 8px;
            text-align: center;
            border: 1px solid var(--border);
        }

        .stat-value {
            display: block;
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary);
        }

        .stat-label {
            display: block;
            font-size: 0.7rem;
            color: var(--text-muted);
            margin-top: 2px;
        }

        .search-container {
            margin-bottom: 16px;
        }

        .search-input-wrapper {
            position: relative;
        }

        .search-input-wrapper input {
            padding-left: 36px;
        }

        .form-group { margin-bottom: 16px; }
        .form-group label { 
            display: block; 
            margin-bottom: 6px; 
            font-size: 0.875rem; 
            font-weight: 500;
            color: var(--text-muted);
        }

        input, select { 
            width: 100%; 
            padding: 10px 12px; 
            border: 1px solid var(--border); 
            border-radius: 8px; 
            background: var(--card-bg); 
            color: var(--text); 
            font-size: 0.875rem;
            transition: all 0.2s;
        }
        
        input:focus, select:focus { 
            outline: none; 
            border-color: var(--primary); 
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }
        
        button { 
            background: var(--primary); 
            color: var(--text); 
            border: none; 
            padding: 12px 20px; 
            border-radius: 8px; 
            cursor: pointer; 
            font-weight: 500; 
            font-size: 0.875rem;
            transition: all 0.2s;
            width: 100%;
        }
        button:hover { background: var(--primary-hover); }
        
        .action-btns { display: flex; gap: 8px; margin-top: 12px; }
        .edit-btn { background: var(--success); }
        .edit-btn:hover { background: #16a34a; }
        .delete-btn { background: var(--danger); }
        .delete-btn:hover { background: #dc2626; }

        .import-section { 
            margin-top: 8px; 
            padding: 16px; 
            border: 2px dashed var(--border); 
            border-radius: 12px; 
            text-align: center;
        }

        .region-filter { 
            padding: 16px; 
            background: var(--card-bg); 
            border-radius: 12px;
            border: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .filter-group label {
            font-size: 0.75rem;
            color: var(--text-muted);
            font-weight: 500;
        }

        /* Scope Type Styles */
        .scope-type {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .scope-checkbox {
            display: flex;
            align-items: center;
            gap: 6px;
            background: var(--card-bg);
            padding: 8px 12px;
            border-radius: 8px;
            border: 1px solid var(--border);
            cursor: pointer;
            transition: all 0.2s;
        }

        .scope-checkbox:hover {
            border-color: var(--primary);
        }

        .scope-checkbox input[type="checkbox"] {
            width: auto;
            margin: 0;
            cursor: pointer;
        }

        .scope-checkbox label {
            margin: 0;
            cursor: pointer;
            font-size: 0.875rem;
            color: var(--text);
        }

        .scope-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.7rem;
            font-weight: 600;
            margin-left: 4px;
        }

        .scope-badge.regional {
            background: rgba(34, 197, 94, 0.2);
            color: #22c55e;
        }

        .scope-badge.national {
            background: rgba(99, 102, 241, 0.2);
            color: #6366f1;
        }

        /* Reset View Button */
        .reset-view-btn {
            background: var(--card-bg);
            color: var(--text-muted);
            border: 1px solid var(--border);
            padding: 8px 12px;
            font-size: 0.75rem;
            margin-bottom: 8px;
        }

        .reset-view-btn:hover {
            background: var(--primary);
            color: var(--text);
            border-color: var(--primary);
        }

        /* Modal Styles */
        #modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--modal-overlay);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background: var(--sidebar-bg);
            padding: 32px;
            border-radius: 16px;
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
            border: 1px solid var(--border);
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }
        .close-modal {
            background: transparent;
            color: var(--text-muted);
            width: auto;
            padding: 0;
            font-size: 1.5rem;
        }
        .close-modal:hover { background: transparent; color: var(--text); }

        /* Leaflet Dark Mode Customization */
        .leaflet-container {
            background: #111827 !important;
        }
        .leaflet-popup-content-wrapper {
            background: var(--sidebar-bg);
            color: var(--text);
            border-radius: 12px;
        }
        .leaflet-popup-tip { background: var(--sidebar-bg); }
    </style>
</head>
<body>
    <div id="login-overlay">
        <div class="login-box">
            <h2 style="margin-bottom: 24px; text-align: center;">Connexion</h2>
            <div class="form-group">
                <label>Nom d'utilisateur</label>
                <input type="text" id="login-username">
            </div>
            <div class="form-group">
                <label>Mot de passe</label>
                <input type="password" id="login-password" onkeypress="if(event.key==='Enter') login()">
            </div>
            <button onclick="login()">Se connecter</button>
            <p id="login-error" style="color: var(--danger); margin-top: 16px; display: none; text-align: center; font-size: 0.875rem;"></p>
        </div>
    </div>

    <div id="main-content" style="display: none; width: 100%; height: 100%; display: flex;">
        <div id="sidebar">
        <button onclick="openModal()" style="margin-bottom: 20px;">+ Ajouter un contact</button>

        <div class="import-section">
            <label style="display: block; margin-bottom: 8px; font-weight: 500; font-size: 0.75rem; color: var(--text-muted);">IMPORTER DES DONN√âES (.xlsx, .csv)</label>
            <input type="file" id="excel-import" accept=".xlsx, .xls, .csv" onchange="importExcel(this)" style="font-size: 0.75rem;">
            <a href="/api/template" download="modele_contacts.xlsx" style="display:inline-block;margin-top:8px;font-size:0.72rem;color:#60a5fa;text-decoration:none;border:1px solid #374151;border-radius:6px;padding:4px 10px;background:#1f2937;" onmouseover="this.style.background='#374151'" onmouseout="this.style.background='#1f2937'">üì• T√©l√©charger le mod√®le Excel</a>
        </div>

        <div class="region-filter">
            <label style="display: block; margin-bottom: 4px; font-weight: 600; font-size: 0.875rem;">Filtres</label>
            
            <!-- Bouton R√©initialiser la vue -->
            <button class="reset-view-btn" onclick="resetMapView()">üîÑ R√©initialiser la vue</button>
            
            <div class="filter-group">
                <label>Par R√©gion</label>
                <select id="region-select" onchange="filterData()">
                    <option value="all">Toutes les r√©gions</option>
                </select>
            </div>
            <div class="filter-group">
                <label>Par Entreprise</label>
                <select id="company-select" onchange="filterData()">
                    <option value="all">Toutes les entreprises</option>
                </select>
            </div>
            <div class="filter-group">
                <label>Par Port√©e</label>
                <select id="scope-select" onchange="filterData()">
                    <option value="all">Tous</option>
                    <option value="regional">R√©gional uniquement</option>
                    <option value="national">National uniquement</option>
                    <option value="both">R√©gional & National</option>
                </select>
            </div>
        </div>

        <div id="contact-list">
            <div class="search-container">
                <div class="contact-stats">
                    <div class="stat-card">
                        <span class="stat-value" id="total-contacts">0</span>
                        <span class="stat-label">Contacts</span>
                    </div>
                    <div class="stat-card">
                        <span class="stat-value" id="total-cities">0</span>
                        <span class="stat-label">Villes</span>
                    </div>
                </div>
                <div class="search-input-wrapper" style="margin-bottom: 12px;">
                    <span style="position: absolute; left: 12px; color: var(--text-muted);">üîç</span>
                    <input type="text" id="contact-search" placeholder="Rechercher un nom, ville, entreprise..." oninput="filterData()">
                </div>
                <button onclick="copyAllEmails()" style="background: var(--card-bg); color: var(--text-muted); font-size: 0.75rem; padding: 6px; border: 1px solid var(--border);">üìã Copier tous les emails</button>
            </div>
            <div id="contacts"></div>
        </div>
    </div>
    
    <div id="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modal-title">Nouveau Contact</h2>
                <button class="close-modal" onclick="closeModal()">&times;</button>
            </div>
            <div id="add-contact-form">
                <input type="hidden" id="edit-id">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                    <div class="form-group">
                        <label>Pr√©nom *</label>
                        <input type="text" id="first_name" placeholder="Jean" required>
                    </div>
                    <div class="form-group">
                        <label>Nom</label>
                        <input type="text" id="last_name" placeholder="Dupont">
                    </div>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                    <div class="form-group">
                        <label>Email</label>
                        <input type="email" id="email" placeholder="jean@exemple.com">
                    </div>
                    <div class="form-group">
                        <label>T√©l√©phone</label>
                        <input type="tel" id="phone" placeholder="06 00 00 00 00">
                    </div>
                </div>
                <div class="form-group">
                    <label>Ville *</label>
                    <input type="text" id="city" placeholder="Paris, France" required>
                </div>
                <div class="form-group">
                    <label>R√©gion</label>
                    <input type="text" id="region" placeholder="D√©termin√©e automatiquement" readonly>
                </div>
                <div class="form-group">
                    <label>Entreprise</label>
                    <input type="text" id="company" placeholder="ACME Inc.">
                </div>
                <div class="form-group">
                    <label>Port√©e du contact</label>
                    <div class="scope-type">
                        <div class="scope-checkbox">
                            <input type="checkbox" id="scope-regional" value="regional">
                            <label for="scope-regional">R√©gional</label>
                        </div>
                        <div class="scope-checkbox">
                            <input type="checkbox" id="scope-national" value="national">
                            <label for="scope-national">National</label>
                        </div>
                    </div>
                </div>
                <button id="save-btn" onclick="saveContact()">Enregistrer le contact</button>
            </div>
        </div>
    </div>
    <div id="map"></div>

    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        const socket = io();
        const map = L.map('map', { zoomControl: false }).setView([46.2276, 2.2137], 6);
        L.control.zoom({ position: 'topright' }).addTo(map);

        L.tileLayer('https://{s}.tile.openstreetmap.fr/osmfr/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://osmfr.org">OpenStreetMap France</a>',
            maxZoom: 20
        }).addTo(map);

        let contacts = [];
        let markers = {};
        let currentRegion = 'all';
        let currentCompany = 'all';
        let currentScope = 'all';
        let regionLayer, deptLayer, currentDeptDisplay;
        let companyColors = {};

        async function login() {
            const username = document.getElementById('login-username').value;
            const password = document.getElementById('login-password').value;
            const error = document.getElementById('login-error');

            try {
                const res = await fetch('/api/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });
                const data = await res.json();
                if (data.success) {
                    document.getElementById('login-overlay').style.display = 'none';
                    document.getElementById('main-content').style.display = 'flex';
                    await loadContacts();
                    map.invalidateSize();
                } else {
                    error.innerText = data.message;
                    error.style.display = 'block';
                }
            } catch (err) {
                error.innerText = "Erreur de connexion";
                error.style.display = 'block';
            }
        }

        async function loadContacts() {
            const res = await fetch('/api/contacts');
            contacts = await res.json();
            refreshUI();
        }

        function refreshUI() {
            updateFilters();
            filterData();
        }

        socket.on('contactsUpdated', (newContacts) => {
            contacts = newContacts;
            refreshUI();
        });

        const colors = [
            '#6366f1', '#ef4444', '#10b981', '#f59e0b', '#3b82f6', 
            '#8b5cf6', '#ec4899', '#06b6d4', '#84cc16', '#f97316'
        ];

        function getCompanyColor(company) {
            if (!company) return '#6366f1';
            if (!companyColors[company]) {
                const colorIndex = Object.keys(companyColors).length % colors.length;
                companyColors[company] = colors[colorIndex];
            }
            return companyColors[company];
        }

        // Fonction pour r√©initialiser la vue de la carte
        function resetMapView() {
            map.setView([46.2276, 2.2137], 6);
            currentRegion = 'all';
            document.getElementById('region-select').value = 'all';
            
            // Supprimer l'affichage des d√©partements
            if (currentDeptDisplay) {
                map.removeLayer(currentDeptDisplay);
                currentDeptDisplay = null;
            }
            
            // R√©initialiser les styles des r√©gions
            if (regionLayer) {
                regionLayer.eachLayer(l => {
                    l.setStyle({ fillOpacity: 0.1 });
                });
            }
            
            filterData();
        }

        async function init() {
            updateFilters();
            filterData();
            await loadRegions();
            await loadDepts();
        }

        async function loadRegions() {
            try {
                const res = await fetch('https://raw.githubusercontent.com/gregoiredavid/france-geojson/master/regions-version-simplifiee.geojson');
                const data = await res.json();
                
                regionLayer = L.geoJSON(data, {
                    style: (feature) => ({
                        fillColor: '#6366f1',
                        weight: 2,
                        opacity: 1,
                        color: '#475569',
                        fillOpacity: 0.1
                    }),
                    onEachFeature: (feature, layer) => {
                        layer.on({
                            mouseover: (e) => {
                                if (map.getZoom() < 8) e.target.setStyle({ fillOpacity: 0.4 });
                            },
                            mouseout: (e) => {
                                if (map.getZoom() < 8 && e.target.feature.properties.nom !== currentRegion) {
                                    e.target.setStyle({ fillOpacity: 0.1 });
                                }
                            },
                            click: (e) => {
                                currentRegion = feature.properties.nom;
                                document.getElementById('region-select').value = currentRegion;
                                map.fitBounds(e.target.getBounds());
                                filterData();
                                showDepts(feature.properties.code);
                            }
                        });
                    }
                }).addTo(map);
            } catch (err) {
                console.error('Failed to load regions:', err);
            }
        }

        async function loadDepts() {
            try {
                const res = await fetch('departements.geojson');
                const data = await res.json();
                deptLayer = L.geoJSON(data);
            } catch (err) {
                console.error('Failed to load depts:', err);
            }
        }

        function showDepts(regionCode) {
            if (!deptLayer) return;
            if (currentDeptDisplay) map.removeLayer(currentDeptDisplay);

            const regionToDepts = {
                '11': ['75','77','78','91','92','93','94','95'],
                '24': ['18','28','36','37','41','45'],
                '27': ['21','25','39','58','70','71','89','90'],
                '28': ['14','27','50','61','76'],
                '32': ['02','59','60','62','80'],
                '44': ['08','10','51','52','54','55','57','67','68','88'],
                '52': ['44','49','53','72','85'],
                '53': ['22','29','35','56'],
                '75': ['16','17','19','23','24','33','40','47','64','79','86','87'],
                '76': ['09','11','12','30','31','32','34','46','48','65','66','81','82'],
                '84': ['01','03','07','15','26','38','42','43','63','69','73','74'],
                '93': ['04','05','06','13','83','84'],
                '94': ['2A','2B']
            };

            const targetDepts = regionToDepts[regionCode] || [];
            const filteredFeatures = deptLayer.toGeoJSON().features.filter(f => targetDepts.includes(f.properties.code));
            
            // CORRECTION: Changer la couleur de bordure de blanc (#fff) √† une couleur visible (#22c55e)
            currentDeptDisplay = L.geoJSON(filteredFeatures, {
                style: { 
                    fillColor: '#10b981', 
                    weight: 2, 
                    opacity: 1, 
                    color: '#22c55e',  // Chang√© de '#fff' √† '#22c55e' (vert visible)
                    fillOpacity: 0.2 
                },
                onEachFeature: (feature, layer) => {
                    layer.bindTooltip(feature.properties.nom);
                    layer.on('click', (e) => {
                        L.DomEvent.stopPropagation(e);
                        map.fitBounds(e.target.getBounds());
                    });
                }
            }).addTo(map);
        }

        function updateFilters() {
            const regionSelect = document.getElementById('region-select');
            const companySelect = document.getElementById('company-select');
            
            const regions = [...new Set(contacts.map(c => c.region))].filter(Boolean).sort();
            const companies = [...new Set(contacts.map(c => c.company))].filter(Boolean).sort();
            
            regionSelect.innerHTML = '<option value="all">Toutes les r√©gions</option>';
            regions.forEach(r => regionSelect.add(new Option(r, r)));
            
            companySelect.innerHTML = '<option value="all">Toutes les entreprises</option>';
            companies.forEach(c => companySelect.add(new Option(c, c)));

            regionSelect.value = currentRegion;
            companySelect.value = currentCompany;
        }

        function filterData() {
            currentRegion = document.getElementById('region-select').value;
            currentCompany = document.getElementById('company-select').value;
            currentScope = document.getElementById('scope-select').value;
            const searchTerm = (document.getElementById('contact-search')?.value || '').toLowerCase();
            
            Object.values(markers).forEach(m => map.removeLayer(m));
            markers = {};
            
            const filtered = contacts.filter(c => {
                const matchRegion = currentRegion === 'all' || c.region === currentRegion;
                const matchCompany = currentCompany === 'all' || c.company === currentCompany;
                const matchSearch = !searchTerm || 
                    (c.firstName + ' ' + (c.lastName || '')).toLowerCase().includes(searchTerm) ||
                    (c.city || '').toLowerCase().includes(searchTerm) ||
                    (c.company || '').toLowerCase().includes(searchTerm) ||
                    (c.email || '').toLowerCase().includes(searchTerm);
                
                // Filtre par port√©e (scope)
                let matchScope = true;
                if (currentScope === 'regional') {
                    matchScope = c.scopeRegional && !c.scopeNational;
                } else if (currentScope === 'national') {
                    matchScope = c.scopeNational && !c.scopeRegional;
                } else if (currentScope === 'both') {
                    matchScope = c.scopeRegional && c.scopeNational;
                }
                
                return matchRegion && matchCompany && matchSearch && matchScope;
            });

            renderContacts(filtered);
            filtered.forEach(addMarkerToMap);
            
            if (regionLayer) {
                regionLayer.eachLayer(l => {
                    l.setStyle({ fillOpacity: (l.feature.properties.nom === currentRegion ? 0.4 : 0.1) });
                });
            }

            const totalContactsEl = document.getElementById('total-contacts');
            const totalCitiesEl = document.getElementById('total-cities');
            if (totalContactsEl) totalContactsEl.innerText = filtered.length;
            if (totalCitiesEl) totalCitiesEl.innerText = new Set(filtered.map(c => c.city)).size;
        }

        async function findRegion(lat, lon) {
            if (!regionLayer) return '';
            let found = '';
            regionLayer.eachLayer(layer => {
                if (layer.getBounds().contains([lat, lon])) {
                    found = layer.feature.properties.nom;
                }
            });
            return found;
        }

        document.getElementById('city').addEventListener('blur', async (e) => {
            const city = e.target.value;
            if (!city) return;
            
            const regionInput = document.getElementById('region');
            regionInput.placeholder = 'Recherche...';
            
            const coords = await geocode(city);
            if (coords) {
                const region = await findRegion(coords.lat, coords.lon);
                regionInput.value = region;
            }
            regionInput.placeholder = 'D√©termin√©e automatiquement';
        });

        async function geocode(city) {
            try {
                const response = await fetch(`https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(city)}&format=json&limit=1&accept-language=fr`, {
                    headers: { 'User-Agent': 'ContactMapApp/1.0' }
                });
                const data = await response.json();
                if (data.length > 0) {
                    return { lat: parseFloat(data[0].lat), lon: parseFloat(data[0].lon), fullName: data[0].display_name };
                }
            } catch (error) {
                console.error('Geocoding error:', error);
            }
            return null;
        }

        async function saveContact() {
            const saveBtn = document.getElementById('save-btn');
            const originalText = saveBtn.innerText;
            const editId = document.getElementById('edit-id').value; // CORRECTION: Capturer l'ID avant le try-catch
            
            saveBtn.innerText = 'Localisation...';
            saveBtn.disabled = true;

            try {
                const firstName = document.getElementById('first_name').value;
                const lastName = document.getElementById('last_name').value;
                const email = document.getElementById('email').value;
                const phone = document.getElementById('phone').value;
                const city = document.getElementById('city').value;
                const company = document.getElementById('company').value;
                const scopeRegional = document.getElementById('scope-regional').checked;
                const scopeNational = document.getElementById('scope-national').checked;

                if (!firstName || !city) throw new Error('Le pr√©nom et la ville sont obligatoires');

                const coords = await geocode(city);
                if (!coords) throw new Error('Ville non trouv√©e');

                const region = await findRegion(coords.lat, coords.lon);

                const contactData = { 
                    id: editId || Date.now().toString(), 
                    firstName, lastName, email, phone, city, region, company,
                    scopeRegional, scopeNational,
                    lat: coords.lat, lon: coords.lon, fullName: coords.fullName 
                };

                if (editId) {
                    const index = contacts.findIndex(c => c.id === editId);
                    contacts[index] = contactData;
                } else {
                    contacts.push(contactData);
                }

                await fetch('/api/contacts', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(contacts)
                });

                // CORRECTION: R√©initialiser le formulaire AVANT de fermer le modal
                resetForm();
                closeModal();
                map.setView([contactData.lat, contactData.lon], 12);
            } catch (err) {
                alert(err.message);
                saveBtn.innerText = originalText;
                saveBtn.disabled = false;
            }
        }

        function addMarkerToMap(contact) {
            const matchRegion = currentRegion === 'all' || contact.region === currentRegion;
            const matchCompany = currentCompany === 'all' || contact.company === currentCompany;
            if (!matchRegion || !matchCompany) return;

            const color = getCompanyColor(contact.company);
            const icon = L.divIcon({
                className: 'custom-div-icon',
                html: `<div style="background-color: ${color}; width: 14px; height: 14px; border-radius: 50%; border: 2px solid white; box-shadow: 0 0 10px rgba(0,0,0,0.5);"></div>`,
                iconSize: [14, 14],
                iconAnchor: [7, 7]
            });

            // G√©n√©rer les badges de port√©e
            let scopeBadges = '';
            if (contact.scopeRegional) scopeBadges += '<span class="scope-badge regional">R√©gional</span>';
            if (contact.scopeNational) scopeBadges += '<span class="scope-badge national">National</span>';

            const marker = L.marker([contact.lat, contact.lon], { icon }).addTo(map)
                .bindPopup(`
                    <div style="font-family: 'Inter', sans-serif; min-width: 200px;">
                        <b style="font-size: 1rem;">${contact.firstName} ${contact.lastName || ''}</b>${scopeBadges}<br>
                        <span style="color: ${color}; font-weight: 600; font-size: 0.8rem;">${contact.company || 'Priv√©'}</span><br>
                        <hr style="border: 0; border-top: 1px solid var(--border); margin: 8px 0;">
                        ${contact.email ? `<p style="margin: 4px 0; font-size: 0.875rem;">üìß ${contact.email}</p>` : ''}
                        ${contact.phone ? `<p style="margin: 4px 0; font-size: 0.875rem;">üìû ${contact.phone}</p>` : ''}
                        <p style="margin: 4px 0; font-size: 0.875rem;">üìç ${contact.city}</p>
                        <p style="margin: 4px 0; font-size: 0.75rem; color: var(--text-muted);">üó∫Ô∏è ${contact.region || 'N/A'}</p>
                    </div>
                `);
            markers[contact.id] = marker;
        }

        function renderContacts(filtered = null) {
            const container = document.getElementById('contacts');
            container.innerHTML = '';
            
            if (!filtered) {
                const searchTerm = (document.getElementById('contact-search')?.value || '').toLowerCase();
                filtered = contacts.filter(c => {
                    const matchRegion = currentRegion === 'all' || c.region === currentRegion;
                    const matchCompany = currentCompany === 'all' || c.company === currentCompany;
                    const matchSearch = !searchTerm || 
                        (c.firstName + ' ' + (c.lastName || '')).toLowerCase().includes(searchTerm) ||
                        (c.city || '').toLowerCase().includes(searchTerm) ||
                        (c.company || '').toLowerCase().includes(searchTerm);
                    return matchRegion && matchCompany && matchSearch;
                });
            }

            filtered.forEach(contact => {
                const color = getCompanyColor(contact.company);
                
                // G√©n√©rer les badges de port√©e
                let scopeBadges = '';
                if (contact.scopeRegional) scopeBadges += '<span class="scope-badge regional">R√©gional</span>';
                if (contact.scopeNational) scopeBadges += '<span class="scope-badge national">National</span>';
                
                const div = document.createElement('div');
                div.className = 'contact-item';
                div.style.setProperty('--company-color', color);
                div.innerHTML = `
                    <div style="padding-left: 8px;">
                        <h3>${contact.firstName} ${contact.lastName || ''}${scopeBadges}</h3>
                        <p style="color: ${color}; font-weight: 600;">üè¢ ${contact.company || 'Priv√©'}</p>
                        ${contact.email ? `<p>üìß ${contact.email}</p>` : ''}
                        ${contact.phone ? `<p>üìû ${contact.phone}</p>` : ''}
                        <p>üìç ${contact.city}</p>
                        <div class="action-btns">
                            <button class="edit-btn" onclick="editContact('${contact.id}')">Modifier</button>
                            <button class="delete-btn" onclick="deleteContact('${contact.id}')">Supprimer</button>
                        </div>
                    </div>
                `;
                container.appendChild(div);
            });
        }

        function copyAllEmails() {
            const emails = contacts.map(c => c.email).filter(Boolean).join('; ');
            if (!emails) return alert('Aucun email trouv√©');
            navigator.clipboard.writeText(emails);
            alert('Tous les emails ont √©t√© copi√©s dans le presse-papier !');
        }

        function editContact(id) {
            const contact = contacts.find(c => c.id === id);
            document.getElementById('edit-id').value = contact.id;
            document.getElementById('first_name').value = contact.firstName;
            document.getElementById('last_name').value = contact.lastName;
            document.getElementById('email').value = contact.email || '';
            document.getElementById('phone').value = contact.phone || '';
            document.getElementById('city').value = contact.city;
            document.getElementById('region').value = contact.region || '';
            document.getElementById('company').value = contact.company || '';
            document.getElementById('scope-regional').checked = contact.scopeRegional || false;
            document.getElementById('scope-national').checked = contact.scopeNational || false;
            document.getElementById('modal-title').innerText = 'Modifier le contact';
            document.getElementById('save-btn').innerText = 'Mettre √† jour';
            openModal();
        }

        function openModal() {
            document.getElementById('modal-overlay').style.display = 'flex';
        }

        function closeModal() {
            document.getElementById('modal-overlay').style.display = 'none';
            // CORRECTION: Ne PAS r√©initialiser le formulaire ici pour √©viter les conflits
            // La r√©initialisation se fait maintenant dans saveContact() avant closeModal()
        }

        async function deleteContact(id) {
            if (confirm('Supprimer ce contact ?')) {
                contacts = contacts.filter(c => c.id !== id);
                await fetch('/api/contacts', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(contacts)
                });
            }
        }

        function parseScope(scopeStr) {
            if (!scopeStr) return { scopeRegional: false, scopeNational: false };
            const s = scopeStr.toString().toLowerCase();
            return {
                scopeRegional: s.includes('r√©gional') || s.includes('regional'),
                scopeNational: s.includes('national')
            };
        }

        function showImportProgress(message, current, total) {
            let bar = document.getElementById('import-progress-bar');
            if (!bar) {
                const container = document.createElement('div');
                container.id = 'import-progress-container';
                container.style.cssText = `
                    position: fixed; top: 0; left: 0; width: 100%; z-index: 9999;
                    background: rgba(0,0,0,0.7); display: flex; align-items: center;
                    justify-content: center; height: 100%; flex-direction: column; gap: 16px;
                `;
                container.innerHTML = `
                    <div style="background: #1f2937; border: 1px solid #374151; border-radius: 12px; padding: 32px; min-width: 360px; text-align: center;">
                        <div style="font-size: 1rem; font-weight: 600; color: #f9fafb; margin-bottom: 16px;" id="import-progress-msg"></div>
                        <div style="background: #374151; border-radius: 9999px; height: 10px; overflow: hidden; margin-bottom: 10px;">
                            <div id="import-progress-bar" style="background: #3b82f6; height: 100%; width: 0%; transition: width 0.3s ease; border-radius: 9999px;"></div>
                        </div>
                        <div style="font-size: 0.8rem; color: #9ca3af;" id="import-progress-count"></div>
                    </div>
                `;
                document.body.appendChild(container);
                bar = document.getElementById('import-progress-bar');
            }
            const pct = total > 0 ? Math.round((current / total) * 100) : 0;
            bar.style.width = pct + '%';
            document.getElementById('import-progress-msg').textContent = message;
            document.getElementById('import-progress-count').textContent = `${current} / ${total}`;
        }

        function hideImportProgress() {
            const el = document.getElementById('import-progress-container');
            if (el) el.remove();
        }

        async function importExcel(input) {
            const file = input.files[0];
            if (!file) return;
            // Reset file input so the same file can be re-imported if needed
            input.value = '';

            const reader = new FileReader();
            reader.onload = async (e) => {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });

                    // Trouver la feuille qui contient les colonnes de contacts (pas forc√©ment la premi√®re)
                    const contactColumns = ['city', 'first_name', 'ville', 'prenom', 'first name'];
                    let sheetName = workbook.SheetNames[0];
                    for (const name of workbook.SheetNames) {
                        const testRows = XLSX.utils.sheet_to_json(workbook.Sheets[name], { header: 1 });
                        if (testRows.length > 0) {
                            const headers = (testRows[0] || []).map(h => String(h || '').toLowerCase().trim());
                            if (contactColumns.some(col => headers.includes(col))) {
                                sheetName = name;
                                break;
                            }
                        }
                    }

                    const rows = XLSX.utils.sheet_to_json(workbook.Sheets[sheetName]);

                    if (rows.length === 0) {
                        alert('Le fichier est vide ou le format est incorrect.');
                        return;
                    }

                    let imported = 0;
                    let skipped = 0;
                    const skippedRows = [];

                    showImportProgress('D√©marrage de l\'import...', 0, rows.length);

                    for (let i = 0; i < rows.length; i++) {
                        const row = rows[i];

                        const city      = (row.city       || row.City       || row.Ville      || '').toString().trim();
                        const firstName = (row.first_name || row['First Name'] || row.Prenom  || '').toString().trim();
                        const lastName  = (row.last_name  || row['Last Name']  || row.Nom     || '').toString().trim();
                        const company   = (row.Company    || row.company    || row.Entreprise  || '').toString().trim();
                        const email     = (row.email      || row.Email      || '').toString().trim();
                        const phone     = (row.phone      || row.Phone      || row.Telephone   || '').toString().trim();
                        const regionFromFile = (row.Region || row.region || '').toString().trim();
                        const deliveryZone   = (row.delivery_zone || row['Delivery Zone'] || '').toString().trim();
                        const scopeStr       = (row.Scope  || row.scope     || '').toString().trim();
                        const { scopeRegional, scopeNational } = parseScope(scopeStr);

                        if (!firstName && !city) {
                            skipped++;
                            skippedRows.push(`Ligne ${i + 2}: pr√©nom et ville manquants`);
                            showImportProgress(`Import en cours...`, i + 1, rows.length);
                            continue;
                        }

                        showImportProgress(`G√©ocodage : ${city || '(sans ville)'}...`, i + 1, rows.length);

                        let lat, lon, fullName, region;

                        if (city) {
                            const coords = await geocode(city);
                            if (coords) {
                                lat = coords.lat;
                                lon = coords.lon;
                                fullName = coords.fullName;
                                // Prefer region from geojson layer, fallback to Excel value
                                region = await findRegion(lat, lon) || regionFromFile;
                                await new Promise(r => setTimeout(r, 1100));
                            } else {
                                // Geocoding failed but we still have region from Excel
                                region = regionFromFile;
                            }
                        } else {
                            region = regionFromFile;
                        }

                        contacts.push({
                            id: Date.now().toString() + Math.random(),
                            firstName,
                            lastName,
                            email,
                            phone,
                            city,
                            region,
                            company,
                            deliveryZone,
                            scopeRegional,
                            scopeNational,
                            lat:  lat  || null,
                            lon:  lon  || null,
                            fullName: fullName || ''
                        });
                        imported++;
                    }

                    showImportProgress('Sauvegarde...', rows.length, rows.length);

                    await fetch('/api/contacts', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(contacts)
                    });

                    hideImportProgress();
                    filterData();
                    updateFilters();

                    let msg = `‚úÖ Import termin√© !\n\n‚Ä¢ ${imported} contact(s) import√©(s)`;
                    if (skipped > 0) {
                        msg += `\n‚Ä¢ ${skipped} ligne(s) ignor√©e(s) (pr√©nom et ville manquants)`;
                    }
                    if (skippedRows.length > 0 && skippedRows.length <= 5) {
                        msg += '\n\nD√©tails :\n' + skippedRows.join('\n');
                    }
                    alert(msg);

                } catch (err) {
                    hideImportProgress();
                    alert('Erreur lors de l\'import : ' + err.message);
                    console.error(err);
                }
            };
            reader.readAsArrayBuffer(file);
        }

        function resetForm() {
            document.getElementById('edit-id').value = '';
            document.getElementById('first_name').value = '';
            document.getElementById('last_name').value = '';
            document.getElementById('email').value = '';
            document.getElementById('phone').value = '';
            document.getElementById('city').value = '';
            document.getElementById('region').value = '';
            document.getElementById('company').value = '';
            document.getElementById('scope-regional').checked = false;
            document.getElementById('scope-national').checked = false;
            document.getElementById('modal-title').innerText = 'Nouveau Contact';
            document.getElementById('save-btn').innerText = 'Enregistrer le contact';
        }

        init();
    </script>
</body>
</html>
