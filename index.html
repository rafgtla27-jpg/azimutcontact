<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Contact Map | AzimutTrans</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.sheetjs.com/xlsx-0.20.3/package/dist/xlsx.full.min.js"></script>
    <style>
        :root {
            --primary: #6366f1;
            --primary-hover: #4f46e5;
            --bg: #0f172a;
            --sidebar-bg: #1e293b;
            --card-bg: #263548;
            --card-hover: #2e4060;
            --text: #f1f5f9;
            --text-muted: #94a3b8;
            --border: #334155;
            --success: #22c55e;
            --danger: #ef4444;
            --warning: #f59e0b;
        }

        *, *::before, *::after { box-sizing: border-box; }

        body {
            margin: 0;
            font-family: 'Inter', sans-serif;
            background: var(--bg);
            color: var(--text);
            overflow: hidden;
            height: 100vh;
        }

        /* ‚îÄ‚îÄ LOGIN ‚îÄ‚îÄ */
        #login-overlay {
            position: fixed; inset: 0;
            background: var(--bg);
            z-index: 3000;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .login-box {
            background: var(--sidebar-bg);
            padding: 48px 40px;
            border-radius: 20px;
            width: 100%;
            max-width: 400px;
            box-shadow: 0 32px 64px rgba(0,0,0,0.5);
            border: 1px solid var(--border);
        }
        .login-logo {
            text-align: center;
            margin-bottom: 32px;
        }
        .login-logo span {
            font-size: 2rem;
            font-weight: 700;
            background: linear-gradient(135deg, #6366f1, #8b5cf6);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .login-logo p { color: var(--text-muted); font-size: 0.875rem; margin: 4px 0 0; }

        /* ‚îÄ‚îÄ LAYOUT ‚îÄ‚îÄ */
        #main-content {
            display: none;
            width: 100%;
            height: 100vh;
            flex-direction: row;
        }
        #main-content.visible { display: flex !important; }

        /* ‚îÄ‚îÄ SIDEBAR ‚îÄ‚îÄ */
        #sidebar {
            width: 300px;
            min-width: 300px;
            height: 100vh;
            background: var(--sidebar-bg);
            border-right: 1px solid var(--border);
            overflow-y: auto;
            overflow-x: hidden;
            display: flex;
            flex-direction: column;
            gap: 0;
            z-index: 10;
        }
        #sidebar::-webkit-scrollbar { width: 4px; }
        #sidebar::-webkit-scrollbar-track { background: transparent; }
        #sidebar::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }

        .sidebar-header {
            padding: 20px;
            border-bottom: 1px solid var(--border);
            background: linear-gradient(180deg, #1e293b 0%, #162032 100%);
            position: sticky;
            top: 0;
            z-index: 5;
        }
        .sidebar-header h1 {
            font-size: 1rem;
            font-weight: 700;
            margin: 0 0 2px;
            background: linear-gradient(135deg, #818cf8, #c084fc);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .sidebar-header p { margin: 0; font-size: 0.7rem; color: var(--text-muted); }

        .sidebar-section {
            padding: 16px;
            border-bottom: 1px solid var(--border);
        }
        .sidebar-section-title {
            font-size: 0.65rem;
            font-weight: 600;
            letter-spacing: 0.1em;
            color: var(--text-muted);
            text-transform: uppercase;
            margin: 0 0 10px;
        }

        /* ‚îÄ‚îÄ MAP ‚îÄ‚îÄ */
        #map { flex: 1; height: 100vh; min-width: 0; }

        /* ‚îÄ‚îÄ CONTACT LIST ‚îÄ‚îÄ */
        #contact-list {
            width: 310px;
            min-width: 310px;
            height: 100vh;
            background: var(--sidebar-bg);
            border-left: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        .contact-list-header {
            padding: 16px;
            border-bottom: 1px solid var(--border);
            background: linear-gradient(180deg, #1e293b 0%, #162032 100%);
            position: sticky;
            top: 0;
            flex-shrink: 0;
        }
        #contacts-scroll {
            flex: 1;
            overflow-y: auto;
            padding: 12px;
        }
        #contacts-scroll::-webkit-scrollbar { width: 4px; }
        #contacts-scroll::-webkit-scrollbar-track { background: transparent; }
        #contacts-scroll::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }

        /* ‚îÄ‚îÄ STATS ‚îÄ‚îÄ */
        .contact-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin-bottom: 12px;
        }
        .stat-card {
            background: var(--card-bg);
            padding: 10px 12px;
            border-radius: 10px;
            text-align: center;
            border: 1px solid var(--border);
        }
        .stat-value { display: block; font-size: 1.4rem; font-weight: 700; color: var(--primary); }
        .stat-label { display: block; font-size: 0.65rem; color: var(--text-muted); margin-top: 1px; }

        /* ‚îÄ‚îÄ SEARCH ‚îÄ‚îÄ */
        .search-wrapper {
            position: relative;
            margin-bottom: 10px;
        }
        .search-wrapper svg {
            position: absolute;
            left: 10px;
            top: 50%;
            transform: translateY(-50%);
            width: 14px;
            height: 14px;
            stroke: var(--text-muted);
        }
        #search-input {
            width: 100%;
            background: var(--card-bg);
            border: 1px solid var(--border);
            color: var(--text);
            font-size: 0.8rem;
            padding: 8px 12px 8px 32px;
            border-radius: 8px;
            outline: none;
            transition: all 0.2s;
        }
        #search-input:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.15);
        }
        #search-input::placeholder { color: var(--text-muted); }

        /* ‚îÄ‚îÄ FILTERS ‚îÄ‚îÄ */
        .filters {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
            margin-top: 8px;
        }
        .filter-tag {
            background: var(--card-bg);
            border: 1px solid var(--border);
            padding: 5px 10px;
            border-radius: 8px;
            font-size: 0.7rem;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 4px;
        }
        .filter-tag:hover { background: var(--card-hover); }
        .filter-tag.active {
            background: var(--primary);
            border-color: var(--primary);
            color: #fff;
        }

        /* ‚îÄ‚îÄ CONTACT CARD ‚îÄ‚îÄ */
        .contact-card {
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 10px 12px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
        }
        .contact-card:hover { background: var(--card-hover); transform: translateX(-2px); }
        .contact-card.selected {
            background: linear-gradient(135deg, rgba(99,102,241,0.15), rgba(139,92,246,0.15));
            border-color: var(--primary);
        }
        .contact-name {
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--text);
            margin: 0 0 4px;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .contact-company {
            font-size: 0.7rem;
            color: var(--text-muted);
            margin: 0 0 6px;
        }
        .contact-location {
            font-size: 0.7rem;
            color: var(--text-muted);
            display: flex;
            align-items: center;
            gap: 4px;
        }
        .contact-scope-badge {
            display: inline-flex;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.6rem;
            font-weight: 600;
            margin-left: auto;
        }
        .contact-scope-badge.regional { background: rgba(34,197,94,0.2); color: #22c55e; }
        .contact-scope-badge.national { background: rgba(99,102,241,0.2); color: #818cf8; }

        /* ‚îÄ‚îÄ BUTTONS ‚îÄ‚îÄ */
        .btn {
            padding: 10px 16px;
            border-radius: 10px;
            font-size: 0.8rem;
            font-weight: 600;
            cursor: pointer;
            border: 1px solid;
            transition: all 0.2s;
            text-align: center;
            font-family: 'Inter', sans-serif;
        }
        .btn-primary {
            background: var(--primary);
            color: #fff;
            border-color: var(--primary);
        }
        .btn-primary:hover { background: var(--primary-hover); }
        .btn-outline {
            background: transparent;
            color: var(--text);
            border-color: var(--border);
        }
        .btn-outline:hover { background: var(--card-bg); }
        .btn-danger {
            background: var(--danger);
            color: #fff;
            border-color: var(--danger);
        }
        .btn-danger:hover { background: #dc2626; }

        /* ‚îÄ‚îÄ MODAL ‚îÄ‚îÄ */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.75);
            z-index: 2000;
            display: none;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(4px);
        }
        .modal-overlay.active { display: flex; }
        .modal {
            background: var(--sidebar-bg);
            border: 1px solid var(--border);
            border-radius: 18px;
            padding: 24px;
            max-width: 600px;
            width: 90%;
            max-height: 85vh;
            overflow-y: auto;
        }
        .modal h2 {
            font-size: 1.2rem;
            margin: 0 0 16px;
            color: var(--text);
        }
        .form-group {
            margin-bottom: 14px;
        }
        .form-label {
            display: block;
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--text-muted);
            margin-bottom: 6px;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        .form-input, .form-textarea, .form-select {
            width: 100%;
            background: var(--card-bg);
            border: 1px solid var(--border);
            color: var(--text);
            padding: 10px 12px;
            border-radius: 8px;
            font-size: 0.85rem;
            font-family: 'Inter', sans-serif;
            outline: none;
            transition: all 0.2s;
        }
        .form-input:focus, .form-textarea:focus, .form-select:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.15);
        }
        .form-textarea { min-height: 60px; resize: vertical; }
        .form-checkbox-group {
            display: flex;
            gap: 16px;
            align-items: center;
        }
        .checkbox-label {
            display: flex;
            align-items: center;
            gap: 6px;
            cursor: pointer;
            font-size: 0.8rem;
        }
        .checkbox-label input[type="checkbox"] {
            width: 16px;
            height: 16px;
            cursor: pointer;
        }
        .modal-actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        /* ‚îÄ‚îÄ TOAST ‚îÄ‚îÄ */
        .toast {
            position: fixed;
            bottom: 24px;
            right: 24px;
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 14px 18px;
            min-width: 280px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.4);
            z-index: 9999;
            transform: translateX(400px);
            transition: transform 0.3s ease;
        }
        .toast.show { transform: translateX(0); }
        .toast.success { border-color: var(--success); }
        .toast.error { border-color: var(--danger); }

        /* ‚îÄ‚îÄ BACK TO TOP ‚îÄ‚îÄ */
        #back-top-btn {
            position: fixed;
            bottom: 24px;
            left: 320px;
            background: var(--primary);
            color: #fff;
            width: 44px;
            height: 44px;
            border-radius: 50%;
            border: none;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(99,102,241,0.4);
            z-index: 100;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transform: translateY(20px);
            transition: all 0.3s;
            pointer-events: none;
        }
        #back-top-btn.visible {
            opacity: 1;
            transform: translateY(0);
            pointer-events: all;
        }
        #back-top-btn:hover { background: var(--primary-hover); }

        /* ‚îÄ‚îÄ CLUSTER CUSTOM ‚îÄ‚îÄ */
        .marker-cluster {
            background: rgba(99, 102, 241, 0.6);
            border: 2px solid var(--primary);
        }
        .marker-cluster div {
            background: var(--primary);
            color: white;
            font-weight: 700;
        }

        /* ‚îÄ‚îÄ ZONE SELECTOR ‚îÄ‚îÄ */
        .zone-selector {
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 12px;
        }
        .zone-selector-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        .zone-tabs {
            display: flex;
            gap: 6px;
            margin-bottom: 10px;
        }
        .zone-tab {
            flex: 1;
            padding: 6px;
            background: transparent;
            border: 1px solid var(--border);
            border-radius: 6px;
            font-size: 0.7rem;
            cursor: pointer;
            transition: all 0.2s;
            color: var(--text-muted);
        }
        .zone-tab.active {
            background: var(--primary);
            border-color: var(--primary);
            color: white;
        }
        .zone-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(70px, 1fr));
            gap: 6px;
            max-height: 200px;
            overflow-y: auto;
        }
        .zone-item {
            padding: 6px 8px;
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 6px;
            font-size: 0.7rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
        }
        .zone-item:hover { background: var(--card-hover); }
        .zone-item.selected {
            background: var(--primary);
            border-color: var(--primary);
            color: white;
        }
        .selected-zones-display {
            margin-top: 8px;
            padding: 8px;
            background: var(--bg);
            border-radius: 6px;
            font-size: 0.7rem;
            min-height: 32px;
            color: var(--text-muted);
        }
        .selected-zone-tag {
            display: inline-block;
            background: var(--primary);
            color: white;
            padding: 2px 8px;
            border-radius: 4px;
            margin: 2px;
            font-size: 0.65rem;
        }

        /* ‚îÄ‚îÄ CONTACTS TOUTE FRANCE ‚îÄ‚îÄ */
        .no-location-section {
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 12px;
            margin-bottom: 12px;
        }
        .no-location-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 10px;
            cursor: pointer;
        }
        .no-location-title {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.8rem;
            font-weight: 600;
            color: var(--warning);
        }
        .no-location-count {
            background: rgba(245, 158, 11, 0.2);
            color: var(--warning);
            padding: 2px 8px;
            border-radius: 6px;
            font-size: 0.7rem;
            font-weight: 600;
        }
        .no-location-list {
            display: none;
            margin-top: 8px;
        }
        .no-location-list.expanded {
            display: block;
        }

        /* ‚îÄ‚îÄ MAP CONTROLS ‚îÄ‚îÄ */
        .map-controls {
            position: absolute;
            top: 16px;
            right: 16px;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .map-control-btn {
            background: white;
            border: 2px solid rgba(0,0,0,0.2);
            border-radius: 8px;
            padding: 10px;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            transition: all 0.2s;
            font-size: 0.75rem;
            font-weight: 600;
            color: #333;
        }
        .map-control-btn:hover {
            background: #f8f9fa;
        }
        .map-control-btn.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }
    </style>
</head>
<body>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     LOGIN OVERLAY
     ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="login-overlay">
    <div class="login-box">
        <div class="login-logo">
            <span>üó∫Ô∏è AzimutTrans</span>
            <p>Contact Map ¬∑ Connexion</p>
        </div>
        <div class="form-group">
            <label class="form-label">Mot de passe</label>
            <input type="password" id="password-input" class="form-input" placeholder="Entrez le mot de passe" onkeypress="if(event.key==='Enter') checkPassword()">
        </div>
        <button class="btn btn-primary" style="width:100%;" onclick="checkPassword()">Se connecter</button>
        <div id="login-error" style="color:var(--danger);font-size:0.75rem;margin-top:8px;display:none;">Mot de passe incorrect</div>
    </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     MAIN CONTENT
     ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="main-content">
    <!-- ‚îÄ‚îÄ SIDEBAR ‚îÄ‚îÄ -->
    <div id="sidebar">
        <div class="sidebar-header">
            <h1>üó∫Ô∏è AzimutTrans</h1>
            <p>Gestion des contacts</p>
        </div>

        <div class="sidebar-section">
            <div class="sidebar-section-title">Actions</div>
            <button class="btn btn-primary" style="width:100%;margin-bottom:8px;" onclick="openContactModal()">+ Nouveau contact</button>
            <button class="btn btn-outline" style="width:100%;margin-bottom:8px;" onclick="document.getElementById('excel-input').click()">üì• Importer Excel</button>
            <input type="file" id="excel-input" accept=".xlsx,.xls" style="display:none;" onchange="importExcel(this)">
            <button class="btn btn-outline" style="width:100%;" onclick="exportExcel()">üì§ Exporter Excel</button>
        </div>

        <div class="sidebar-section">
            <div class="sidebar-section-title">Filtres</div>
            <div class="filters" id="filters-container"></div>
        </div>

        <div class="sidebar-section">
            <div class="sidebar-section-title">Statistiques</div>
            <div class="contact-stats">
                <div class="stat-card">
                    <span class="stat-value" id="stat-total">0</span>
                    <span class="stat-label">TOTAL</span>
                </div>
                <div class="stat-card">
                    <span class="stat-value" id="stat-regional">0</span>
                    <span class="stat-label">R√âGIONAL</span>
                </div>
                <div class="stat-card">
                    <span class="stat-value" id="stat-national">0</span>
                    <span class="stat-label">NATIONAL</span>
                </div>
                <div class="stat-card">
                    <span class="stat-value" id="stat-no-location">0</span>
                    <span class="stat-label">TOUTE FRANCE</span>
                </div>
            </div>
        </div>
    </div>

    <!-- ‚îÄ‚îÄ MAP ‚îÄ‚îÄ -->
    <div id="map"></div>

    <!-- Map Controls -->
    <div class="map-controls">
        <button class="map-control-btn" id="toggle-departments" onclick="toggleDepartments()">
            üìç D√©partements
        </button>
        <button class="map-control-btn" id="toggle-regions" onclick="toggleRegions()">
            üó∫Ô∏è R√©gions
        </button>
    </div>

    <!-- ‚îÄ‚îÄ CONTACT LIST ‚îÄ‚îÄ -->
    <div id="contact-list">
        <div class="contact-list-header">
            <div class="search-wrapper">
                <svg fill="none" viewBox="0 0 24 24" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-5.197-5.197m0 0A7.5 7.5 0 105.196 5.196a7.5 7.5 0 0010.607 10.607z" />
                </svg>
                <input type="text" id="search-input" placeholder="Rechercher un contact..." oninput="applyFilters()">
            </div>
        </div>
        <div id="contacts-scroll"></div>
    </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     CONTACT MODAL
     ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="modal-overlay" id="contact-modal">
    <div class="modal">
        <h2 id="modal-title">Nouveau contact</h2>
        <form id="contact-form" onsubmit="saveContact(event)">
            <div class="form-group">
                <label class="form-label">Pr√©nom *</label>
                <input type="text" id="edit-firstName" class="form-input" required>
            </div>
            <div class="form-group">
                <label class="form-label">Nom</label>
                <input type="text" id="edit-lastName" class="form-input">
            </div>
            <div class="form-group">
                <label class="form-label">Entreprise</label>
                <input type="text" id="edit-company" class="form-input">
            </div>
            <div class="form-group">
                <label class="form-label">Email</label>
                <input type="email" id="edit-email" class="form-input">
            </div>
            <div class="form-group">
                <label class="form-label">T√©l√©phone</label>
                <input type="tel" id="edit-phone" class="form-input">
            </div>
            <div class="form-group">
                <label class="form-label">Ville</label>
                <input type="text" id="edit-city" class="form-input">
            </div>
            <div class="form-group">
                <label class="form-label">R√©gion</label>
                <input type="text" id="edit-region" class="form-input">
            </div>
            
            <!-- Zone de livraison -->
            <div class="form-group">
                <label class="form-label">Zones de livraison</label>
                <div class="zone-selector">
                    <div class="zone-tabs">
                        <button type="button" class="zone-tab active" onclick="switchZoneTab('departments')">D√©partements</button>
                        <button type="button" class="zone-tab" onclick="switchZoneTab('regions')">R√©gions</button>
                    </div>
                    <div class="zone-grid" id="zone-departments"></div>
                    <div class="zone-grid" id="zone-regions" style="display:none;"></div>
                    <div class="selected-zones-display" id="selected-zones-display">
                        Aucune zone s√©lectionn√©e
                    </div>
                </div>
            </div>

            <div class="form-group">
                <label class="form-label">P√©rim√®tre</label>
                <div class="form-checkbox-group">
                    <label class="checkbox-label">
                        <input type="checkbox" id="edit-scopeRegional">
                        <span>R√©gional</span>
                    </label>
                    <label class="checkbox-label">
                        <input type="checkbox" id="edit-scopeNational">
                        <span>National</span>
                    </label>
                </div>
            </div>

            <div class="modal-actions">
                <button type="submit" class="btn btn-primary" style="flex:1;">Enregistrer</button>
                <button type="button" class="btn btn-outline" style="flex:1;" onclick="closeContactModal()">Annuler</button>
                <button type="button" class="btn btn-danger" id="delete-btn" style="display:none;" onclick="deleteContact()">Supprimer</button>
            </div>
        </form>
    </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     BACK TO TOP
     ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<button id="back-top-btn" onclick="scrollToTop()">‚Üë</button>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     SCRIPTS
     ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// GLOBAL VARIABLES
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const CORRECT_PASSWORD = 'azimut2025';
let contacts = [];
let map, markerClusterGroup;
let departmentLayers = null;
let regionLayers = null;
let showDepartments = false;
let showRegions = false;
let currentEditingId = null;
let selectedZones = { departments: [], regions: [] };
let currentZoneTab = 'departments';

// D√©partements fran√ßais (01-95)
const DEPARTMENTS = [
    '01', '02', '03', '04', '05', '06', '07', '08', '09', '10',
    '11', '12', '13', '14', '15', '16', '17', '18', '19', '21',
    '22', '23', '24', '25', '26', '27', '28', '29', '2A', '2B',
    '30', '31', '32', '33', '34', '35', '36', '37', '38', '39',
    '40', '41', '42', '43', '44', '45', '46', '47', '48', '49',
    '50', '51', '52', '53', '54', '55', '56', '57', '58', '59',
    '60', '61', '62', '63', '64', '65', '66', '67', '68', '69',
    '70', '71', '72', '73', '74', '75', '76', '77', '78', '79',
    '80', '81', '82', '83', '84', '85', '86', '87', '88', '89',
    '90', '91', '92', '93', '94', '95'
];

// R√©gions fran√ßaises
const REGIONS = [
    'Auvergne-Rh√¥ne-Alpes',
    'Bourgogne-Franche-Comt√©',
    'Bretagne',
    'Centre-Val de Loire',
    'Corse',
    'Grand Est',
    'Hauts-de-France',
    '√éle-de-France',
    'Normandie',
    'Nouvelle-Aquitaine',
    'Occitanie',
    'Pays de la Loire',
    'Provence-Alpes-C√¥te d\'Azur'
];

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// LOGIN
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function checkPassword() {
    const input = document.getElementById('password-input').value;
    const error = document.getElementById('login-error');
    if (input === CORRECT_PASSWORD) {
        document.getElementById('login-overlay').style.display = 'none';
        document.getElementById('main-content').classList.add('visible');
        init();
    } else {
        error.style.display = 'block';
    }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// INITIALIZATION
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function init() {
    initMap();
    initZoneSelector();
    await loadFromServer();
    refreshUI();
    initBackToTopBtn();
}

function initMap() {
    map = L.map('map').setView([46.603354, 1.888334], 6);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '¬© OpenStreetMap contributors'
    }).addTo(map);

    markerClusterGroup = L.markerClusterGroup({
        maxClusterRadius: 50,
        spiderfyOnMaxZoom: true,
        showCoverageOnHover: false,
        zoomToBoundsOnClick: true
    });
    map.addLayer(markerClusterGroup);
}

function initZoneSelector() {
    // Departments
    const deptGrid = document.getElementById('zone-departments');
    DEPARTMENTS.forEach(dept => {
        const item = document.createElement('div');
        item.className = 'zone-item';
        item.textContent = dept;
        item.onclick = () => toggleZone('departments', dept, item);
        deptGrid.appendChild(item);
    });

    // Regions
    const regionGrid = document.getElementById('zone-regions');
    REGIONS.forEach(region => {
        const item = document.createElement('div');
        item.className = 'zone-item';
        item.textContent = region;
        item.onclick = () => toggleZone('regions', region, item);
        regionGrid.appendChild(item);
    });
}

function switchZoneTab(tab) {
    currentZoneTab = tab;
    document.querySelectorAll('.zone-tab').forEach(t => t.classList.remove('active'));
    event.target.classList.add('active');
    
    document.getElementById('zone-departments').style.display = tab === 'departments' ? 'grid' : 'none';
    document.getElementById('zone-regions').style.display = tab === 'regions' ? 'grid' : 'none';
}

function toggleZone(type, zone, element) {
    const index = selectedZones[type].indexOf(zone);
    if (index > -1) {
        selectedZones[type].splice(index, 1);
        element.classList.remove('selected');
    } else {
        selectedZones[type].push(zone);
        element.classList.add('selected');
    }
    updateSelectedZonesDisplay();
}

function updateSelectedZonesDisplay() {
    const display = document.getElementById('selected-zones-display');
    const allZones = [
        ...selectedZones.departments.map(d => `D√©p. ${d}`),
        ...selectedZones.regions
    ];
    
    if (allZones.length === 0) {
        display.innerHTML = 'Aucune zone s√©lectionn√©e';
    } else {
        display.innerHTML = allZones.map(z => `<span class="selected-zone-tag">${z}</span>`).join('');
    }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// MAP ZONES
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function toggleDepartments() {
    showDepartments = !showDepartments;
    document.getElementById('toggle-departments').classList.toggle('active', showDepartments);
    updateMapZones();
}

function toggleRegions() {
    showRegions = !showRegions;
    document.getElementById('toggle-regions').classList.toggle('active', showRegions);
    updateMapZones();
}

function updateMapZones() {
    // Clear existing layers
    if (departmentLayers) {
        map.removeLayer(departmentLayers);
        departmentLayers = null;
    }
    if (regionLayers) {
        map.removeLayer(regionLayers);
        regionLayers = null;
    }

    // Show departments (simplified visualization)
    if (showDepartments) {
        departmentLayers = L.layerGroup().addTo(map);
        // In a real implementation, you would load GeoJSON data for departments
        // For now, we'll show a message
        toast('üìç Affichage des d√©partements (fonctionnalit√© compl√®te n√©cessite GeoJSON)', 'info');
    }

    // Show regions (simplified visualization)
    if (showRegions) {
        regionLayers = L.layerGroup().addTo(map);
        // In a real implementation, you would load GeoJSON data for regions
        toast('üó∫Ô∏è Affichage des r√©gions (fonctionnalit√© compl√®te n√©cessite GeoJSON)', 'info');
    }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CONTACT MANAGEMENT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function openContactModal(contactId = null) {
    currentEditingId = contactId;
    const modal = document.getElementById('contact-modal');
    const title = document.getElementById('modal-title');
    const deleteBtn = document.getElementById('delete-btn');
    
    // Reset zones
    selectedZones = { departments: [], regions: [] };
    document.querySelectorAll('.zone-item').forEach(item => item.classList.remove('selected'));
    updateSelectedZonesDisplay();

    if (contactId) {
        const contact = contacts.find(c => c.id === contactId);
        if (contact) {
            title.textContent = 'Modifier le contact';
            document.getElementById('edit-firstName').value = contact.firstName || '';
            document.getElementById('edit-lastName').value = contact.lastName || '';
            document.getElementById('edit-company').value = contact.company || '';
            document.getElementById('edit-email').value = contact.email || '';
            document.getElementById('edit-phone').value = contact.phone || '';
            document.getElementById('edit-city').value = contact.city || '';
            document.getElementById('edit-region').value = contact.region || '';
            document.getElementById('edit-scopeRegional').checked = contact.scopeRegional || false;
            document.getElementById('edit-scopeNational').checked = contact.scopeNational || false;
            
            // Load zones
            if (contact.deliveryZones) {
                selectedZones = JSON.parse(JSON.stringify(contact.deliveryZones));
                // Mark selected zones in UI
                selectedZones.departments.forEach(dept => {
                    const item = Array.from(document.querySelectorAll('#zone-departments .zone-item'))
                        .find(el => el.textContent === dept);
                    if (item) item.classList.add('selected');
                });
                selectedZones.regions.forEach(region => {
                    const item = Array.from(document.querySelectorAll('#zone-regions .zone-item'))
                        .find(el => el.textContent === region);
                    if (item) item.classList.add('selected');
                });
                updateSelectedZonesDisplay();
            }
            
            deleteBtn.style.display = 'block';
        }
    } else {
        title.textContent = 'Nouveau contact';
        document.getElementById('contact-form').reset();
        deleteBtn.style.display = 'none';
    }
    
    modal.classList.add('active');
}

function closeContactModal() {
    document.getElementById('contact-modal').classList.remove('active');
    currentEditingId = null;
}

async function saveContact(event) {
    event.preventDefault();
    
    const firstName = document.getElementById('edit-firstName').value.trim();
    const lastName = document.getElementById('edit-lastName').value.trim();
    const company = document.getElementById('edit-company').value.trim();
    const email = document.getElementById('edit-email').value.trim();
    const phone = document.getElementById('edit-phone').value.trim();
    const city = document.getElementById('edit-city').value.trim();
    const region = document.getElementById('edit-region').value.trim();
    const scopeRegional = document.getElementById('edit-scopeRegional').checked;
    const scopeNational = document.getElementById('edit-scopeNational').checked;

    let lat = null, lon = null, fullName = '';
    
    if (city) {
        const coords = await geocode(city);
        if (coords) {
            lat = coords.lat;
            lon = coords.lon;
            fullName = coords.fullName;
        }
    }

    const contactData = {
        firstName, lastName, company, email, phone, city, region,
        scopeRegional, scopeNational, lat, lon, fullName,
        deliveryZones: { ...selectedZones }
    };

    if (currentEditingId) {
        const index = contacts.findIndex(c => c.id === currentEditingId);
        if (index > -1) {
            contacts[index] = { ...contacts[index], ...contactData };
        }
    } else {
        contacts.push({
            id: Date.now().toString() + Math.random(),
            ...contactData
        });
    }

    await saveToServer();
    refreshUI();
    closeContactModal();
    toast(currentEditingId ? '‚úÖ Contact mis √† jour' : '‚úÖ Contact cr√©√©');
}

function deleteContact() {
    if (!currentEditingId) return;
    if (!confirm('Supprimer ce contact ?')) return;
    
    contacts = contacts.filter(c => c.id !== currentEditingId);
    saveToServer();
    refreshUI();
    closeContactModal();
    toast('üóëÔ∏è Contact supprim√©');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// UI REFRESH
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function refreshUI() {
    updateStats();
    updateFilters();
    applyFilters();
}

function updateStats() {
    const regional = contacts.filter(c => c.scopeRegional).length;
    const national = contacts.filter(c => c.scopeNational).length;
    const noLocation = contacts.filter(c => !c.lat && !c.lon).length;
    
    document.getElementById('stat-total').textContent = contacts.length;
    document.getElementById('stat-regional').textContent = regional;
    document.getElementById('stat-national').textContent = national;
    document.getElementById('stat-no-location').textContent = noLocation;
}

function updateFilters() {
    const container = document.getElementById('filters-container');
    const regions = [...new Set(contacts.map(c => c.region).filter(Boolean))].sort();
    
    container.innerHTML = `
        <div class="filter-tag active" data-filter="all">Tous</div>
        <div class="filter-tag" data-filter="regional">R√©gional</div>
        <div class="filter-tag" data-filter="national">National</div>
        ${regions.map(r => `<div class="filter-tag" data-filter="region:${r}">${r}</div>`).join('')}
    `;
    
    container.querySelectorAll('.filter-tag').forEach(tag => {
        tag.onclick = () => {
            container.querySelectorAll('.filter-tag').forEach(t => t.classList.remove('active'));
            tag.classList.add('active');
            applyFilters();
        };
    });
}

function applyFilters() {
    const searchTerm = document.getElementById('search-input').value.toLowerCase();
    const activeFilter = document.querySelector('.filter-tag.active')?.dataset.filter || 'all';
    
    let filtered = contacts;
    
    // Apply filter
    if (activeFilter !== 'all') {
        if (activeFilter === 'regional') {
            filtered = filtered.filter(c => c.scopeRegional);
        } else if (activeFilter === 'national') {
            filtered = filtered.filter(c => c.scopeNational);
        } else if (activeFilter.startsWith('region:')) {
            const region = activeFilter.split(':')[1];
            filtered = filtered.filter(c => c.region === region);
        }
    }
    
    // Apply search
    if (searchTerm) {
        filtered = filtered.filter(c =>
            (c.firstName || '').toLowerCase().includes(searchTerm) ||
            (c.lastName || '').toLowerCase().includes(searchTerm) ||
            (c.company || '').toLowerCase().includes(searchTerm) ||
            (c.city || '').toLowerCase().includes(searchTerm)
        );
    }
    
    displayContacts(filtered);
    updateMap(filtered);
}

function displayContacts(contactList) {
    const container = document.getElementById('contacts-scroll');
    
    // S√©parer les contacts avec et sans localisation
    const withLocation = contactList.filter(c => c.lat && c.lon);
    const noLocation = contactList.filter(c => !c.lat && !c.lon);
    
    let html = '';
    
    // Section "Contacts Toute France"
    if (noLocation.length > 0) {
        html += `
            <div class="no-location-section">
                <div class="no-location-header" onclick="toggleNoLocationList()">
                    <div class="no-location-title">
                        <span>üá´üá∑</span>
                        <span>Contacts Toute France</span>
                    </div>
                    <div class="no-location-count">${noLocation.length}</div>
                </div>
                <div class="no-location-list" id="no-location-list">
                    ${noLocation.map(c => generateContactCard(c)).join('')}
                </div>
            </div>
        `;
    }
    
    // Contacts avec localisation
    html += withLocation.map(c => generateContactCard(c)).join('');
    
    container.innerHTML = html;
}

function toggleNoLocationList() {
    const list = document.getElementById('no-location-list');
    list.classList.toggle('expanded');
}

function generateContactCard(contact) {
    const scopeBadges = [];
    if (contact.scopeRegional) scopeBadges.push('<span class="contact-scope-badge regional">R√©gional</span>');
    if (contact.scopeNational) scopeBadges.push('<span class="contact-scope-badge national">National</span>');
    
    return `
        <div class="contact-card" onclick="openContactModal('${contact.id}')">
            <div class="contact-name">
                ${contact.firstName} ${contact.lastName || ''}
                ${scopeBadges.join('')}
            </div>
            ${contact.company ? `<div class="contact-company">${contact.company}</div>` : ''}
            <div class="contact-location">
                üìç ${contact.fullName || contact.city || 'Aucune localisation'}
            </div>
        </div>
    `;
}

function updateMap(contactList) {
    markerClusterGroup.clearLayers();
    
    // Grouper les contacts par coordonn√©es (m√™me ville)
    const locationGroups = {};
    
    contactList.forEach(contact => {
        if (contact.lat && contact.lon) {
            const key = `${contact.lat.toFixed(4)},${contact.lon.toFixed(4)}`;
            if (!locationGroups[key]) {
                locationGroups[key] = [];
            }
            locationGroups[key].push(contact);
        }
    });
    
    // Cr√©er des marqueurs
    Object.entries(locationGroups).forEach(([key, contacts]) => {
        const [lat, lon] = key.split(',').map(Number);
        
        let popupContent = '<div style="max-width:250px;">';
        if (contacts.length === 1) {
            const c = contacts[0];
            popupContent += `
                <div style="font-weight:700;margin-bottom:6px;font-size:0.9rem;">${c.firstName} ${c.lastName || ''}</div>
                ${c.company ? `<div style="color:#64748b;font-size:0.8rem;margin-bottom:4px;">${c.company}</div>` : ''}
                ${c.email ? `<div style="font-size:0.75rem;">üìß ${c.email}</div>` : ''}
                ${c.phone ? `<div style="font-size:0.75rem;">üìû ${c.phone}</div>` : ''}
                <div style="margin-top:8px;font-size:0.75rem;color:#64748b;">üìç ${c.fullName || c.city}</div>
            `;
        } else {
            popupContent += `
                <div style="font-weight:700;margin-bottom:8px;font-size:0.9rem;">üìç ${contacts[0].fullName || contacts[0].city}</div>
                <div style="font-size:0.75rem;color:#64748b;margin-bottom:8px;">${contacts.length} contact(s) dans cette ville</div>
            `;
            contacts.forEach(c => {
                popupContent += `
                    <div style="padding:6px;background:#f1f5f9;border-radius:6px;margin-bottom:4px;cursor:pointer;" onclick="openContactModal('${c.id}')">
                        <div style="font-weight:600;font-size:0.8rem;">${c.firstName} ${c.lastName || ''}</div>
                        ${c.company ? `<div style="font-size:0.7rem;color:#64748b;">${c.company}</div>` : ''}
                    </div>
                `;
            });
        }
        popupContent += '</div>';
        
        const marker = L.marker([lat, lon])
            .bindPopup(popupContent);
        
        markerClusterGroup.addLayer(marker);
    });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// GEOCODING
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function geocode(city) {
    try {
        const url = `https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(city + ', France')}&format=json&limit=1`;
        const response = await fetch(url);
        const data = await response.json();
        if (data && data.length > 0) {
            return {
                lat: parseFloat(data[0].lat),
                lon: parseFloat(data[0].lon),
                fullName: data[0].display_name
            };
        }
    } catch (err) {
        console.error('Geocoding error:', err);
    }
    return null;
}

async function findRegion(lat, lon) {
    try {
        const url = `https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lon}&format=json`;
        const response = await fetch(url);
        const data = await response.json();
        return data.address?.state || null;
    } catch (err) {
        console.error('Region lookup error:', err);
    }
    return null;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SERVER SYNC
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function loadFromServer() {
    const stored = localStorage.getItem('azimut_contacts');
    if (stored) {
        contacts = JSON.parse(stored);
    }
}

async function saveToServer() {
    localStorage.setItem('azimut_contacts', JSON.stringify(contacts));
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// EXPORT EXCEL
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function exportExcel() {
    const data = contacts.map(c => ({
        'Pr√©nom': c.firstName || '',
        'Nom': c.lastName || '',
        'Entreprise': c.company || '',
        'Email': c.email || '',
        'T√©l√©phone': c.phone || '',
        'Ville': c.city || '',
        'R√©gion': c.region || '',
        'D√©partements': c.deliveryZones?.departments?.join(', ') || '',
        'R√©gions de livraison': c.deliveryZones?.regions?.join(', ') || '',
        'P√©rim√®tre R√©gional': c.scopeRegional ? 'Oui' : 'Non',
        'P√©rim√®tre National': c.scopeNational ? 'Oui' : 'Non'
    }));

    const ws = XLSX.utils.json_to_sheet(data);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, 'Contacts');
    XLSX.writeFile(wb, `contacts_azimut_${new Date().toISOString().split('T')[0]}.xlsx`);
    toast('üì§ Export r√©ussi');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// IMPORT EXCEL
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function parseScope(s) {
    if (!s) return { scopeRegional: false, scopeNational: false };
    const l = s.toString().toLowerCase();
    return {
        scopeRegional: l.includes('r√©gional') || l.includes('regional'),
        scopeNational: l.includes('national')
    };
}

function showImportProgress(msg, current, total) {
    let el = document.getElementById('import-progress-container');
    if (!el) {
        el = document.createElement('div');
        el.id = 'import-progress-container';
        el.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.75);z-index:9999;display:flex;align-items:center;justify-content:center;';
        el.innerHTML = `
            <div style="background:#1e293b;border:1px solid #334155;border-radius:16px;padding:32px;min-width:380px;text-align:center;">
                <div style="font-size:1rem;font-weight:600;color:#f1f5f9;margin-bottom:6px;" id="imp-msg"></div>
                <div style="font-size:0.75rem;color:#94a3b8;margin-bottom:16px;" id="imp-count"></div>
                <div style="background:#334155;border-radius:999px;height:8px;overflow:hidden;">
                    <div id="imp-bar" style="background:linear-gradient(90deg,#6366f1,#8b5cf6);height:100%;width:0%;transition:width 0.3s ease;border-radius:999px;"></div>
                </div>
            </div>`;
        document.body.appendChild(el);
    }
    const pct = total > 0 ? Math.round((current / total) * 100) : 0;
    document.getElementById('imp-bar').style.width = pct + '%';
    document.getElementById('imp-msg').textContent   = msg;
    document.getElementById('imp-count').textContent = `${current} / ${total}`;
}

function hideImportProgress() {
    const el = document.getElementById('import-progress-container');
    if (el) el.remove();
}

function showImportChoiceDialog(existingCount, newCount) {
    return new Promise(resolve => {
        const ov = document.createElement('div');
        ov.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.8);z-index:10000;display:flex;align-items:center;justify-content:center;backdrop-filter:blur(4px);';
        ov.innerHTML = `
            <div style="background:#1e293b;border:1px solid #334155;border-radius:18px;padding:32px;max-width:420px;width:90%;font-family:'Inter',sans-serif;animation:modalIn 0.2s ease;">
                <div style="font-size:1.5rem;margin-bottom:8px;">üìÇ</div>
                <div style="font-size:1rem;font-weight:700;color:#f1f5f9;margin-bottom:8px;">Import Excel</div>
                <p style="color:#94a3b8;font-size:0.85rem;margin:0 0 20px;line-height:1.5;">
                    Base actuelle : <strong style="color:#f1f5f9">${existingCount} contact(s)</strong><br>
                    Fichier : <strong style="color:#f1f5f9">${newCount} ligne(s)</strong><br>
                    Que souhaitez-vous faire ?
                </p>
                <div style="display:flex;flex-direction:column;gap:8px;">
                    <button id="bi-replace" style="background:#7f1d1d;color:#f87171;border:1px solid #991b1b;border-radius:10px;padding:12px 16px;cursor:pointer;font-size:0.85rem;font-weight:600;text-align:left;font-family:'Inter',sans-serif;">
                        üóëÔ∏è Remplacer ‚Äî Supprimer les anciens et importer
                    </button>
                    <button id="bi-merge" style="background:#1e3a5f;color:#60a5fa;border:1px solid #1d4ed8;border-radius:10px;padding:12px 16px;cursor:pointer;font-size:0.85rem;font-weight:600;text-align:left;font-family:'Inter',sans-serif;">
                        üîÑ Fusionner ‚Äî Mettre √† jour les existants + nouveaux
                    </button>
                    <button id="bi-cancel" style="background:transparent;color:#94a3b8;border:1px solid #475569;border-radius:10px;padding:10px 16px;cursor:pointer;font-size:0.82rem;font-family:'Inter',sans-serif;">
                        Annuler
                    </button>
                </div>
            </div>`;
        document.body.appendChild(ov);
        ov.querySelector('#bi-replace').onclick = () => { ov.remove(); resolve('replace'); };
        ov.querySelector('#bi-merge').onclick   = () => { ov.remove(); resolve('merge');   };
        ov.querySelector('#bi-cancel').onclick  = () => { ov.remove(); resolve(null);      };
    });
}

async function importExcel(input) {
    const file = input.files[0];
    if (!file) return;
    input.value = '';

    const reader = new FileReader();
    reader.onload = async (e) => {
        try {
            const wb = XLSX.read(new Uint8Array(e.target.result), { type: 'array' });
            const contactCols = ['city', 'first_name', 'ville', 'prenom'];
            let sheetName = wb.SheetNames[0];
            for (const name of wb.SheetNames) {
                const rows0 = XLSX.utils.sheet_to_json(wb.Sheets[name], { header: 1 });
                if (rows0.length > 0) {
                    const headers = (rows0[0] || []).map(h => String(h || '').toLowerCase().trim());
                    if (contactCols.some(c => headers.includes(c))) { sheetName = name; break; }
                }
            }

            const rows = XLSX.utils.sheet_to_json(wb.Sheets[sheetName]);
            if (!rows.length) { toast('Fichier vide ou format incorrect', 'error'); return; }

            let mergeMode = 'replace';
            if (contacts.length > 0) {
                const choice = await showImportChoiceDialog(contacts.length, rows.length);
                if (choice === null) return;
                mergeMode = choice;
            }

            let added = 0, updated = 0, skipped = 0;
            if (mergeMode === 'replace') contacts = [];

            showImportProgress('D√©marrage...', 0, rows.length);

            for (let i = 0; i < rows.length; i++) {
                const row = rows[i];
                const city      = (row.city      || row.City      || row.Ville    || '').toString().trim();
                const firstName = (row.first_name || row['First Name'] || row.Prenom || '').toString().trim();
                const lastName  = (row.last_name  || row['Last Name']  || row.Nom   || '').toString().trim();
                const company   = (row.Company    || row.company   || row.Entreprise || '').toString().trim();
                const email     = (row.email      || row.Email     || '').toString().trim();
                const phone     = (row.phone      || row.Phone     || row.Telephone  || '').toString().trim();
                const regionFF  = (row.Region     || row.region    || '').toString().trim();
                const { scopeRegional, scopeNational } = parseScope(row.Scope || row.scope || '');

                if (!firstName && !city) { skipped++; showImportProgress('Import...', i+1, rows.length); continue; }

                showImportProgress(`üìç ${city || firstName}...`, i+1, rows.length);

                let lat = null, lon = null, fullName = '', region = regionFF;
                if (city) {
                    const coords = await geocode(city);
                    if (coords) {
                        lat = coords.lat; lon = coords.lon; fullName = coords.fullName;
                        region = await findRegion(lat, lon) || regionFF;
                        await new Promise(r => setTimeout(r, 1100));
                    }
                }

                const nc = { 
                    firstName, lastName, email, phone, city, region, company, 
                    scopeRegional, scopeNational, lat, lon, fullName,
                    deliveryZones: { departments: [], regions: [] }
                };

                if (mergeMode === 'merge') {
                    const idx = contacts.findIndex(c =>
                        c.firstName.toLowerCase() === firstName.toLowerCase() &&
                        (c.lastName||'').toLowerCase() === lastName.toLowerCase() &&
                        (c.city||'').toLowerCase() === city.toLowerCase()
                    );
                    if (idx >= 0) { contacts[idx] = { ...contacts[idx], ...nc }; updated++; }
                    else { contacts.push({ id: Date.now().toString() + Math.random(), ...nc }); added++; }
                } else {
                    contacts.push({ id: Date.now().toString() + Math.random(), ...nc }); added++;
                }
            }

            showImportProgress('Sauvegarde...', rows.length, rows.length);
            await saveToServer();
            hideImportProgress();
            refreshUI();

            const parts = [`${added} ajout√©(s)`];
            if (updated) parts.push(`${updated} mis √† jour`);
            if (skipped) parts.push(`${skipped} ignor√©(s)`);
            toast(`‚úÖ Import : ${parts.join(' ¬∑ ')}`);

        } catch (err) {
            hideImportProgress();
            toast('Erreur import : ' + err.message, 'error');
            console.error(err);
        }
    };
    reader.readAsArrayBuffer(file);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// TOAST
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function toast(message, type = 'success') {
    const toast = document.createElement('div');
    toast.className = `toast ${type}`;
    toast.textContent = message;
    document.body.appendChild(toast);
    setTimeout(() => toast.classList.add('show'), 10);
    setTimeout(() => {
        toast.classList.remove('show');
        setTimeout(() => toast.remove(), 300);
    }, 3000);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// BACK TO TOP
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function scrollToTop() {
    document.getElementById('sidebar').scrollTo({ top: 0, behavior: 'smooth' });
    document.getElementById('contacts-scroll').scrollTo({ top: 0, behavior: 'smooth' });
}

function initBackToTopBtn() {
    const btn = document.getElementById('back-top-btn');
    const checkScroll = () => {
        const sb = document.getElementById('sidebar').scrollTop;
        const cs = document.getElementById('contacts-scroll').scrollTop;
        btn.classList.toggle('visible', sb > 150 || cs > 150);
    };
    document.getElementById('sidebar').addEventListener('scroll', checkScroll);
    document.getElementById('contacts-scroll').addEventListener('scroll', checkScroll);
}
</script>
</body>
</html>
